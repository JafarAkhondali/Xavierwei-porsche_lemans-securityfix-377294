function sticksCreate(E){function K(a){var u=new Image;u.onload=function(){var c=u.width,b=u.height,f=document.createElement("canvas");f.width=c;f.height=b;var G=new THREE.Texture(f),d=f.getContext("2d"),p=new THREE.Sprite(new THREE.SpriteMaterial({opacity:a.opacity,map:G}));p.updateInfo=function(f){d.drawImage(u,0,b*TYPES[f.userData.typeIndex].bgOffsetV,c,b/2,0,0,c,b/2);a.drawCallback&&a.drawCallback(d,f.userData);G.needsUpdate=!0;f=f.localToWorld(f.geometry.vertices[1].clone());this.position.copy(f);
this.scale.copy(p.scale0).multiplyScalar(e.position.distanceTo(f)*a.fixedScaleFactor)};p.scale.set(c/b*a.size,a.size,.1);p.scale0=p.scale.clone();p.visible=!1;a.finishCallback&&a.finishCallback(p)};u.src=a.imageUrl}function H(){var a=new THREE.Vector3(0,0,.5);z.unprojectVector(a,e);var c=new THREE.Vector3(12,0,.5);z.unprojectVector(c,e);m=c.x-a.x}var B=!1,I,m,e,w,z,q,g=0,J=0,a=0,x=0,r=window.innerWidth/2,C=window.innerHeight/2,y,c,A,D,d;(function(){function L(){r=window.innerWidth/2;C=window.innerHeight/
2;e.aspect=window.innerWidth/window.innerHeight;e.updateProjectionMatrix();q.setSize(window.innerWidth,window.innerHeight);H()}function u(b){if("undefined"===typeof b.offsetX||"undefined"===typeof b.offsetY){var a=$(b.target).offset();b.offsetX=b.pageX-a.left;b.offsetY=b.pageY-a.top}g=b.offsetX-r;J=-(b.offsetY-C);if(B){b=new THREE.Vector3(g/r,J/C,.5);z.unprojectVector(b,e);b=(new THREE.Raycaster(e.position,b.sub(e.position).normalize())).intersectObjects(A.children);var c;0<b.length&&(c=b[0].object);
c!=d&&(c&&(c.material=c.selectedMaterial),d&&(d.material=d.normalMaterial),d=c,y&&(y.visible=void 0!=d,d&&y.updateInfo(d)),q.render(w,e))}}function F(){requestAnimationFrame(F);!B&&.1<100-c.value&&(c.value+=1,.1>Math.abs(100-c.value)&&(c.value=100,B=!0));if(0<Math.abs(g)-.1*r){var b=0==g?0:0<g?1:-1,f=(Math.abs(g)-.1*r)/(.9*r);x=b*f*4;(0==x?0:0<x?1:-1)!=(0==a?0:0<a?1:-1)&&(a=0)}else x=0;a+=x;a*=.95;.01>Math.abs(a)?a=0:1500<Math.abs(a)&&(a=1500*(0==a?0:0<a?1:-1));b=e.position.x+a;b<m?b=m:b>D-m&&(b=
D-m);e.position.x+=.1*(b-e.position.x);q.render(w,e)}$.ajax({url:"shader/vertex.glessl",type:"GET",async:!0,cache:!1,dataType:"text",success:function(b){$.ajax({url:"shader/fragment.glessl",type:"GET",async:!0,cache:!1,dataType:"text",success:function(a){(function(){I=document.getElementById("container");z=new THREE.Projector;q=new THREE.WebGLRenderer({alpha:!0,antialias:!0});q.setClearColor(0,0);q.setSize(window.innerWidth,window.innerHeight);I.appendChild(q.domElement);w=new THREE.Scene;e=new THREE.PerspectiveCamera(55,
window.innerWidth/window.innerHeight,.5,3E6);K({imageUrl:"image/sticks-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){y=a;w.add(y)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="30px 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("P"+b.rankings+"/"+Math.round(b.teamSize),21,16);a.font="19.65px 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.team,23,60);a.fillText(""+
Math.round(b.speed)+"km/h",132,60);a.fillText("View Profi",23,87);a.fillText("Lap:"+b.lap,132,87)}});c={type:"f",value:0};var d={type:"f",value:100},g={type:"f",value:.6},p={fillPercent:c,color:{type:"c",value:new THREE.Color(13421772)},opacity:{type:"f",value:1},gradientLength:d,gradientStartOpacity:g},r=[{fillPercent:c,color:{type:"c",value:new THREE.Color(TYPES[0].color)},opacity:{type:"f",value:1},gradientLength:d,gradientStartOpacity:g},{fillPercent:c,color:{type:"c",value:new THREE.Color(TYPES[1].color)},
opacity:{type:"f",value:1},gradientLength:d,gradientStartOpacity:g}];A=new THREE.Object3D;w.add(A);dataApi.getTeamData(function(c){if(0!=c.status)console.error("Data status invalid: "+c.message,c);else for(var d=c.data.teams.length,g=420/d,q=[c.data.weibo_total,c.data.twitter_total],v=0;v<d;v++){var m=c.data.teams[v];m.teamSize=q[m.typeIndex];var k=0==v?420:Math.round(g*(d-v+.9*(Math.random()-.5))*100)/100,l=new THREE.PlaneGeometry(3,k,2,Math.ceil(.125*k));l.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/
2));l.applyMatrix((new THREE.Matrix4).makeTranslation(3.4*v,0,-k/2));for(var t=0;t<l.vertices.length;t+=3){var n=l.vertices.length-t,h;h=t/l.vertices.length/15*k;var s=0;1>=h/5&&(s+=4*Math.sin(h/5*Math.PI));.8<=h/5&&(s+=(h-4)*(h-4)/5);h=s;l.vertices[n-3].y=h;l.vertices[n-2].y=h;l.vertices[n-1].y=h}l.dynamic=!1;k={percent:{type:"f",value:[]}};t=l.vertices;h=k.percent.value;for(n=0;n<t.length/3;n++)s=100-n/(t.length/3-1)*100,h.push(s,s,s);n=new THREE.ShaderMaterial({uniforms:p,attributes:k,vertexShader:b,
fragmentShader:a,side:THREE.DoubleSide,transparent:!0});k=[new THREE.ShaderMaterial({uniforms:r[0],attributes:k,vertexShader:b,fragmentShader:a,side:THREE.DoubleSide,transparent:!0}),new THREE.ShaderMaterial({uniforms:r[1],attributes:k,vertexShader:b,fragmentShader:a,side:THREE.DoubleSide,transparent:!0})];stick=new THREE.Mesh(l,n);stick.frustumCulled=!1;stick.matrixAutoUpdate=!1;stick.updateMatrix();stick.userData=m;stick.normalMaterial=n;stick.selectedMaterial=k[m.typeIndex];A.add(stick);D=3.4*
d}e.position.set(0,35,43.8);e.lookAt(new THREE.Vector3(0,0,-400/3));e.position.setX(15);H();window.addEventListener("resize",L,!1);document.addEventListener("mousemove",u,!1);F();E&&E()})})()}})}})})()};
