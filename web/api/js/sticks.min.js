(function(){function F(e){var b=new Image;b.onload=function(){var d=b.width,c=b.height,a=document.createElement("canvas");a.width=d;a.height=c;var A=new THREE.Texture(a),B=a.getContext("2d"),n=new THREE.Sprite(new THREE.SpriteMaterial({opacity:e.opacity,map:A}));n.updateInfo=function(a){B.drawImage(b,0,c*TYPES[a.userData.typeIndex].bgOffsetV,d,c/2,0,0,d,c/2);e.drawCallback&&e.drawCallback(B,a.userData);A.needsUpdate=!0;a=a.localToWorld(a.geometry.vertices[1].clone());this.position.copy(a);this.scale.copy(n.scale0).multiplyScalar(f.position.distanceTo(a)*
e.fixedScaleFactor)};n.scale.set(d/c*e.size,e.size,.1);n.scale0=n.scale.clone();n.visible=!1;e.finishCallback&&e.finishCallback(n)};b.src=e.imageUrl}var C=!1,D,f,u,E,g,s=0,b=0,x=0,q=window.innerWidth/2,v,d,w,y,c;$(function(e){function G(){q=window.innerWidth/2;f.aspect=window.innerWidth/window.innerHeight;f.updateProjectionMatrix();g.setSize(window.innerWidth,window.innerHeight)}function H(a){s=a.clientX-q;if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=e(a.target).offset();
a.offsetX=a.pageX-b.left;a.offsetY=a.pageY-b.top}a=new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);E.unprojectVector(a,f);a=(new THREE.Raycaster(f.position,a.sub(f.position).normalize())).intersectObjects(w.children);var d;0<a.length&&(d=a[0].object);d!=c&&(d&&(d.material=d.selectedMaterial),c&&(c.material=c.normalMaterial),c=d,v&&(v.visible=void 0!=c,c&&v.updateInfo(c)),g.render(u,f))}function z(){requestAnimationFrame(z);!C&&.1<100-d.value&&(d.value+=1,
.1>Math.abs(100-d.value)&&(d.value=100,C=!0));if(0<Math.abs(s)-.1*q){var a=0==s?0:0<s?1:-1,c=(Math.abs(s)-.1*q)/(.9*q);x=a*c*c*c*10}else x=0;b+=x;b*=.95;.01>Math.abs(b)?b=0:1500<Math.abs(b)&&(b=1500*(0==b?0:0<b?1:-1));a=f.position.x+b;0>a?a=0:a>y&&(a=y);f.position.x+=.1*(a-f.position.x);g.render(u,f)}e.ajax({url:"shader/vertex.glessl",type:"GET",async:!0,cache:!1,dataType:"text",success:function(a){e.ajax({url:"shader/fragment.glessl",type:"GET",async:!0,cache:!1,dataType:"text",success:function(b){(function(){D=
document.getElementById("container");E=new THREE.Projector;g=new THREE.WebGLRenderer({alpha:!0,antialias:!0});g.setClearColor(0,0);g.setSize(window.innerWidth,window.innerHeight);D.appendChild(g.domElement);u=new THREE.Scene;f=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3E6);F({imageUrl:"image/sticks-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){v=a;u.add(v)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;
a.textBaseline="top";a.font="30px 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("P"+b.rankings+"/"+Math.round(b.teamSize),21,16);a.font="19.65px 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.team,23,60);a.fillText(""+Math.round(b.speed)+"km/h",132,60);a.fillText("View Profi",23,87);a.fillText("Lap:"+b.lap,132,87)}});d={type:"f",value:0};var c={type:"f",value:100},e={type:"f",value:.6},s={fillPercent:d,color:{type:"c",value:new THREE.Color(13421772)},opacity:{type:"f",
value:1},gradientLength:c,gradientStartOpacity:e},q=[{fillPercent:d,color:{type:"c",value:new THREE.Color(TYPES[0].color)},opacity:{type:"f",value:1},gradientLength:c,gradientStartOpacity:e},{fillPercent:d,color:{type:"c",value:new THREE.Color(TYPES[1].color)},opacity:{type:"f",value:1},gradientLength:c,gradientStartOpacity:e}];w=new THREE.Object3D;u.add(w);dataApi.getTeamData(function(c){if(0!=c.status)console.error("Data status invalid: "+c.message,c);else for(var d=c.data.teams.length,e,n=[c.data.weibo_total,
c.data.twitter_total],g=0;g<d;g++){var t=c.data.teams[g];t.teamSize=n[t.typeIndex];0==g&&(e=400/t.distance);var k=t.distance*e,l=new THREE.PlaneGeometry(3,k,2,Math.ceil(.125*k));l.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));l.applyMatrix((new THREE.Matrix4).makeTranslation(3.4*g,0,-k/2));for(var r=0;r<l.vertices.length;r+=3){var m=l.vertices.length-r,h;h=r/l.vertices.length/15*k;var p=0;1>=h/5&&(p+=3*Math.sin(h/5*Math.PI));.8<=h/5&&(p+=(h-4)*(h-4)/5);h=p;l.vertices[m-3].y=h;l.vertices[m-
2].y=h;l.vertices[m-1].y=h}l.dynamic=!1;k={percent:{type:"f",value:[]}};r=l.vertices;h=k.percent.value;for(m=0;m<r.length/3;m++)p=100-m/(r.length/3-1)*100,h.push(p,p,p);m=new THREE.ShaderMaterial({uniforms:s,attributes:k,vertexShader:a,fragmentShader:b,side:THREE.DoubleSide,transparent:!0});k=[new THREE.ShaderMaterial({uniforms:q[0],attributes:k,vertexShader:a,fragmentShader:b,side:THREE.DoubleSide,transparent:!0}),new THREE.ShaderMaterial({uniforms:q[1],attributes:k,vertexShader:a,fragmentShader:b,
side:THREE.DoubleSide,transparent:!0})];stick=new THREE.Mesh(l,m);stick.frustumCulled=!1;stick.matrixAutoUpdate=!1;stick.updateMatrix();stick.userData=t;stick.normalMaterial=m;stick.selectedMaterial=k[t.typeIndex];w.add(stick);y=3.4*d}f.position.set(0,35,45);f.lookAt(new THREE.Vector3(0,0,-400/3));f.position.setX(15);window.addEventListener("resize",G,!1);document.addEventListener("mousemove",H,!1)})})();z()}})}})})})();
