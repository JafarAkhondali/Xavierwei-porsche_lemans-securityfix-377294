function sticksCreate(D){function K(a){var d=new Image;d.onload=function(){var e=d.width,b=d.height,g=document.createElement("canvas");g.width=e;g.height=b;var F=new THREE.Texture(g),f=g.getContext("2d"),p=new THREE.Sprite(new THREE.SpriteMaterial({opacity:a.opacity,map:F}));p.updateInfo=function(g){f.drawImage(d,0,b*TYPES[g.userData.typeIndex].bgOffsetV/2,e,b/2,0,0,e,b/2);a.drawCallback&&a.drawCallback(f,g.userData);F.needsUpdate=!0;g=g.localToWorld(g.geometry.vertices[1].clone());this.position.copy(g);
this.scale.copy(p.scale0).multiplyScalar(c.position.distanceTo(g)*a.fixedScaleFactor)};p.scale.set(e/b*a.size,a.size,.1);p.scale0=p.scale.clone();p.visible=!1;a.finishCallback&&a.finishCallback(p)};d.src=a.imageUrl}function G(){var a=new THREE.Vector3(0,0,.5);z.unprojectVector(a,c);var d=new THREE.Vector3(12,0,.5);z.unprojectVector(d,c);u=d.x-a.x}var A=!1,H,u,c,m,z,f,h=0,I=0,a=0,x=0,q=window.innerWidth/2,B=window.innerHeight/2,y,d,v,C,e,J;(function(){function L(){q=window.innerWidth/2;B=window.innerHeight/
2;c.aspect=window.innerWidth/window.innerHeight;c.updateProjectionMatrix();f.setSize(window.innerWidth,window.innerHeight);G()}function M(b){if("undefined"===typeof b.offsetX||"undefined"===typeof b.offsetY){var a=$(b.target).offset();b.offsetX=b.pageX-a.left;b.offsetY=b.pageY-a.top}h=b.offsetX-q;I=-(b.offsetY-B);if(A){b=new THREE.Vector3(h/q,I/B,.5);z.unprojectVector(b,c);b=(new THREE.Raycaster(c.position,b.sub(c.position).normalize())).intersectObjects(v.children);var d;0<b.length&&(d=b[0].object);
d!=e&&(d&&(d.material=d.selectedMaterial),e&&(e.material=e.normalMaterial),e=d,y&&(y.visible=void 0!=e,e&&y.updateInfo(e)),f.render(m,c))}}function E(){requestAnimationFrame(E);!A&&.1<100-d.value&&(d.value+=1,.1>Math.abs(100-d.value)&&(d.value=100,A=!0));if(0<Math.abs(h)-.1*q){var b=0==h?0:0<h?1:-1,g=(Math.abs(h)-.1*q)/(.9*q);x=b*g*4;(0==x?0:0<x?1:-1)!=(0==a?0:0<a?1:-1)&&(a=0)}else x=0;a+=x;a*=.95;.01>Math.abs(a)?a=0:1500<Math.abs(a)&&(a=1500*(0==a?0:0<a?1:-1));b=c.position.x+a;b<u?b=u:b>C-u&&(b=
C-u);c.position.x+=.1*(b-c.position.x);f.render(m,c)}$.ajax({url:"shader/vertex.glessl",type:"GET",async:!0,cache:!1,dataType:"text",success:function(b){$.ajax({url:"shader/fragment.glessl",type:"GET",async:!0,cache:!1,dataType:"text",success:function(a){(function(){H=document.getElementById("container");z=new THREE.Projector;f=new THREE.WebGLRenderer({alpha:!0,antialias:!0});f.setClearColor(0,0);f.setSize(window.innerWidth,window.innerHeight);H.appendChild(f.domElement);m=new THREE.Scene;c=new THREE.PerspectiveCamera(55,
window.innerWidth/window.innerHeight,.5,3E6);K({imageUrl:"image/sticks-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){y=a;m.add(y)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="32px 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Rank:"+b.ranking+"/"+Math.round(b.totalCount),21,16);a.font="28px 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.team,23,73);a.fillText(""+
Math.round(b.speed)+"km/h",185,73);a.fillText("Player:"+Math.round(b.player),23,117);a.fillText("Lap:"+b.lap,185,117)}});d={type:"f",value:0};var e={type:"f",value:100},h={type:"f",value:.6},p={fillPercent:d,color:{type:"c",value:new THREE.Color(13421772)},opacity:{type:"f",value:1},gradientLength:e,gradientStartOpacity:h},q=[{fillPercent:d,color:{type:"c",value:new THREE.Color(TYPES[0].color)},opacity:{type:"f",value:1},gradientLength:e,gradientStartOpacity:h},{fillPercent:d,color:{type:"c",value:new THREE.Color(TYPES[1].color)},
opacity:{type:"f",value:1},gradientLength:e,gradientStartOpacity:h}];v=new THREE.Object3D;m.add(v);J=function(c,e){dataApi.getTeamData(c,function(c){if(0!=c.status)console.error("Data status invalid: "+c.message,c);else{for(;0<v.children.length;)v.remove(v.children[0]);A=!1;d.value=0;for(var f=c.data.length,h=420/f,u=c.ext.weibo_total+c.ext.twitter_total,w=0;w<f;w++){var m=c.data[w];m.totalCount=u;var k=0==w?420:Math.round(h*(f-w+.9*(Math.random()-.5))*100)/100,n=new THREE.PlaneGeometry(3,k,2,Math.ceil(.125*
k));n.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));n.applyMatrix((new THREE.Matrix4).makeTranslation(3.4*w,0,-k/2));for(var t=0;t<n.vertices.length;t+=3){var r=n.vertices.length-t,l;l=t/n.vertices.length/15*k;var s=0;1>=l/5&&(s+=4*Math.sin(l/5*Math.PI));.8<=l/5&&(s+=(l-4)*(l-4)/5);l=s;n.vertices[r-3].y=l;n.vertices[r-2].y=l;n.vertices[r-1].y=l}n.dynamic=!1;k={percent:{type:"f",value:[]}};t=n.vertices;l=k.percent.value;for(r=0;r<t.length/3;r++)s=100-r/(t.length/3-1)*100,l.push(s,s,s);
r=new THREE.ShaderMaterial({uniforms:p,attributes:k,vertexShader:b,fragmentShader:a,side:THREE.DoubleSide,transparent:!0});k=[new THREE.ShaderMaterial({uniforms:q[0],attributes:k,vertexShader:b,fragmentShader:a,side:THREE.DoubleSide,transparent:!0}),new THREE.ShaderMaterial({uniforms:q[1],attributes:k,vertexShader:b,fragmentShader:a,side:THREE.DoubleSide,transparent:!0})];stick=new THREE.Mesh(n,m.id==c.ext.user_tid?k[m.typeIndex]:r);stick.frustumCulled=!1;stick.matrixAutoUpdate=!1;stick.updateMatrix();
stick.userData=m;stick.normalMaterial=stick.material;stick.selectedMaterial=k[m.typeIndex];v.add(stick);C=3.4*f}}e&&e()})};c.position.set(0,35,43.8);c.lookAt(new THREE.Vector3(0,0,-400/3));c.position.setX(15);G();window.addEventListener("resize",L,!1);document.addEventListener("mousemove",M,!1);E();D&&D(J)})()}})}})})()};
