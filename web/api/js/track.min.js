function trackCreate(W){function F(a){for(;1<a;)a--;for(;0>a;)a++;return a}function X(a){for(;a>f;)a-=f;for(;0>a;)a+=f;return a}function w(a){a=F(a);return M.getPointAt(a).add(G)}function O(a){a/=f;a=F(a);return M.getTangentAt(a)}function ea(a,m,k){return a<=m?m:a>=k?k:a}function fa(a){for(var m=1,k=0;k<C.length;k++)a>=C[k]&&(m=(0==k%2?1:-1)*Math.cos(ea((a-C[k])*ga,0,Math.PI)));return m}function N(a,m,k){a.position.copy(w(a.userData.distance/f));a=k;void 0===a&&(a=!0);for(k=0;k<m.geometry.vertices.length;k+=
3){var q=m.userData.distance-ha*k/3*(1+.2*m.userData.faster),d=w(q/f),e=O(q).cross(new THREE.Vector3(0,1,0)),s=e.clone().multiplyScalar(m.userData.sideOffset*fa(50*F(q/f))),q=m.geometry.vertices[k+2],c=d.clone().add(s).add(e.clone().multiplyScalar(2));a?q.add(c.sub(q).multiplyScalar(H)):q.copy(c);q=m.geometry.vertices[k+1];c=d.clone().add(s);a?q.add(c.sub(q).multiplyScalar(H)):q.copy(c);q=m.geometry.vertices[k];d=d.clone().add(s).add(e.negate().multiplyScalar(2));a?q.add(d.sub(q).multiplyScalar(H)):
q.copy(d)}m.geometry.verticesNeedUpdate=!0;m.geometry.boundingSphere=null;m.geometry.boundingBox=null;Y()}function ia(a){var d=new Image;d.onload=function(){var k=d.width,e=d.height,f=document.createElement("canvas");f.width=k;f.height=e;var t=new THREE.Texture(f),u=f.getContext("2d");n=new THREE.SpriteMaterial({opacity:a.opacity,map:t});n.depthTest=!1;n.opacity0=n.opacity;var c=new THREE.Sprite(n);c.updateInfo=function(f){u.drawImage(d,0,e*TYPES[f.userData.typeIndex].bgOffsetV/2,k,e/2,0,0,k,e/2);
a.drawCallback&&a.drawCallback(u,f.userData);t.needsUpdate=!0;f=f.localToWorld(f.geometry.vertices[1].clone());this.position.copy(f);this.scale.copy(c.scale0).multiplyScalar(s.position.distanceTo(f)*a.fixedScaleFactor)};c.scale.set(k/e*a.size,a.size,.1);c.scale0=c.scale.clone();c.visible=!1;a.finishCallback&&a.finishCallback(c)};d.src=a.imageUrl}function Y(){I&&(I.visible=void 0!=J,J?(I.updateInfo(J),n.opacity+=.03,n.opacity>n.opacity0&&(n.opacity=n.opacity0)):n.opacity=0)}var Z,s,x,P,y,Q,D,K,E,R=
new THREE.Vector3(0,0,0),ja=new THREE.Vector3(0,0,0),aa=0,ba,S=window.innerWidth/2,M,G=new THREE.Vector3(0,0,0),f,ca,T,t,u,z,d,e,ha=1,L,J,U=[],I,n,V,C,H=.1,ga=10;(function(){$.ajax({url:"data/track.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var m=a.cameraFollow,k=0,q=0;C=a.sideShiftPercents;var n=a.svgFile;"/"!==n[0]&&(n="data/"+n);$.ajax({url:n,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(n){var C=$("g path",n.documentElement).attr("d");dataApi.getRaceData(function(c){if(0!=
c.status)console.error("Data status invalid: "+c.message,c);else{var n=function(a){q=a;t.hilight.visible=0==q;u.hilight.visible=1==q},F=function(){S=window.innerWidth/2;s.aspect=window.innerWidth/window.innerHeight;s.updateProjectionMatrix();y.setSize(window.innerWidth,window.innerHeight)},H=function(a){aa=a.clientX-S;if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var d=$(a.target).offset();a.offsetX=a.pageX-d.left;a.offsetY=a.pageY-d.top}a=new THREE.Vector3(a.offsetX/window.innerWidth*
2-1,2*-(a.offsetY/window.innerHeight)+1,.5);P.unprojectVector(a,s);a=(new THREE.Raycaster(s.position,a.sub(s.position).normalize())).intersectObjects(L.children);var c;0<a.length&&(c=a[0].object);c!=J&&(J=c,Y())},da=function(){requestAnimationFrame(da);var a=Q.getDelta();d.userData.distance+=a*d.userData.speed;d.userData.distance1+=a*d.userData.speed;d.userData.lap=d.userData.lap0+Math.floor(d.userData.distance1/f);e.userData.distance+=a*e.userData.speed;e.userData.distance1+=a*e.userData.speed;e.userData.lap=
e.userData.lap0+Math.floor(e.userData.distance1/f);N(t,d);N(u,e);Math.max(d.userData.distance>e.userData.distance)?(d.userData.rankings=1,e.userData.rankings=2):(e.userData.rankings=1,d.userData.rankings=2);Math.max(d.userData.speed>e.userData.speed)?(d.userData.faster=1,e.userData.faster=0):(d.userData.faster=0,e.userData.faster=1);var a=(0==q?d:e).userData.distance,c=w(a/f).add(ja);R.add(c.sub(R).multiplyScalar(m.lookAtFactor));c=m.locations[k];a=w((a+c.distance)/f);c.height&&(a.y+=c.height);s.position.add(a.sub(s.position).multiplyScalar(m.followFactor));
s.lookAt(R);a=new THREE.Vector3(aa/S,1,0);s.up.add(a.sub(s.up).multiplyScalar(.05));V.rotation=-Q.getElapsedTime()*Math.PI*1.5;y.render(x,s);E.render(K,D)};(function(){Z=document.getElementById("container");P=new THREE.Projector;y=new THREE.WebGLRenderer({alpha:!0,antialias:!0});y.setClearColor(0,0);y.setSize(window.innerWidth,window.innerHeight);Z.appendChild(y.domElement);x=new THREE.Scene;s=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3E6);Q=new THREE.Clock;var p=transformSVGPath(C),
h=p.getLength(),l=[],b;for(b in a.slopes){var g=a.slopes[b];l.push(new THREE.Vector3(g.percent/100*h,g.offset*a.slopeScale,0))}slopePathSplineCurve3=new THREE.ClosedSplineCurve3(l);p=p.getSpacedPoints(1500,!0);h=[];for(b=0;b<p.length;b++)h.push(new THREE.Vector3(p[b].x,slopePathSplineCurve3.getPointAt(b/p.length).y,p[b].y));M=new THREE.ClosedSplineCurve3(h);f=M.getLength();ca=1E3*a.trackLengthKM;T=ca/f;var l=new THREE.PlaneGeometry(7,f,1,1500),A=f/1500;for(b=0;b<l.vertices.length;b+=2){var r=A*b/
2,v=w(r/f),r=O(r),r=r.cross(new THREE.Vector3(0,1,0)),r=r.clone().multiplyScalar(3),B=l.vertices[b+1];B.addVectors(v,r);B=l.vertices[b];B.addVectors(v,r.negate())}l.verticesNeedUpdate=!0;l.computeBoundingSphere();l.computeBoundingBox();G=l.boundingSphere.center.clone().negate();p={name:c.data.weibo.name,distance:c.data.weibo.distance,rankings:c.data.weibo.rankings,lap:c.data.weibo.lap,sideOffset:2.5,typeIndex:c.data.weibo.typeIndex,faster:0};p.speed0=c.data.weibo.speed;p.speed=1E3*(100>c.data.weibo.speed?
100:c.data.weibo.speed)/60/60/T;p.distance1=X(p.distance);p.lap0=p.lap;h={name:c.data.twitter.name,distance:c.data.twitter.distance,rankings:c.data.twitter.rankings,lap:c.data.twitter.lap,sideOffset:-2.5,typeIndex:c.data.twitter.typeIndex,faster:0};h.speed0=c.data.twitter.speed;h.speed=1E3*(100>c.data.twitter.speed?100:c.data.twitter.speed)/60/60/T;h.distance1=X(h.distance);h.lap0=h.lap;K=new THREE.Scene;g=new THREE.PlaneGeometry(7,f,1,1500);A=f/1500;for(b=0;b<g.vertices.length;b+=2)r=A*b/2,v=w(r/
f),r=O(r),r=r.cross(new THREE.Vector3(0,3,0)),r=r.clone().multiplyScalar(3),B=g.vertices[b+1],B.addVectors(v,r),B=g.vertices[b],B.addVectors(v,r.negate());g.verticesNeedUpdate=!0;g.computeBoundingSphere();g.computeBoundingBox();b=g.boundingSphere.center.clone().negate();meshMap=new THREE.Mesh(g,new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}));g=g.boundingBox;A=g.max.x-g.min.x+200;v=g.max.z-g.min.z+200;g=200;r=v/A*g;meshMap.position.add(b);meshMap.matrixAutoUpdate=!1;meshMap.updateMatrix();
K.add(meshMap);map=document.getElementById("map");E=new THREE.WebGLRenderer({alpha:!0,antialias:!0});E.setClearColor(0,0);E.setSize(g,r);map.appendChild(E.domElement);D=new THREE.OrthographicCamera(A/-2,A/2,v/2,v/-2,-500,2E3);D.position.set(0,1E3,0);D.up.set(0,0,-1);D.lookAt(new THREE.Vector3(0,0,0));t=new THREE.Mesh(new THREE.SphereGeometry(30,20,1),new THREE.MeshBasicMaterial({color:16711680}));t.position.set(0,100,0);t.userData=p;K.add(t);U.push(t);b=t.clone();b.material=new THREE.MeshBasicMaterial({color:TYPES[0].color,
transparent:!0,opacity:.5});b.scale.set(3,3,3);b.visible=!1;t.add(b);t.hilight=b;u=new THREE.Mesh(new THREE.SphereGeometry(30,20,1),new THREE.MeshBasicMaterial({color:255}));u.position.set(0,100,0);u.userData=h;K.add(u);U.push(u);b=u.clone();b.material=new THREE.MeshBasicMaterial({color:TYPES[1].color,transparent:!0,opacity:.5});b.scale.set(3,3,3);b.visible=!1;u.add(b);u.hilight=b;b=THREE.ImageUtils.loadTexture("image/track.png?"+(new Date).getTime());b.wrapS=b.wrapT=THREE.RepeatWrapping;b.repeat.set(1,
50);z=new THREE.Mesh(l,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,map:b}));z.geometry.computeBoundingSphere();z.position.add(G);z.matrixAutoUpdate=!1;z.updateMatrix();x.add(z);ba=z.geometry.boundingSphere.radius;l=new THREE.CircleGeometry(3*ba,50);l.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));l.vertices.shift();b=new THREE.Line(l,new THREE.LineBasicMaterial({color:10066329}));b.position.add(G);b.matrixAutoUpdate=!1;b.updateMatrix();x.add(b);l=l.clone();
l.applyMatrix((new THREE.Matrix4).makeTranslation(0,20,0));l=new THREE.Line(l,new THREE.LineBasicMaterial({color:16777215}));l.position.add(G);l.matrixAutoUpdate=!1;l.updateMatrix();x.add(l);L=new THREE.Object3D;x.add(L);l=new THREE.PlaneGeometry(5,50,2,50);d=new THREE.Mesh(l,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red.png?"+(new Date).getTime())}));d.frustumCulled=!1;d.position.set(0,1,0);d.matrixAutoUpdate=
!1;d.updateMatrix();d.userData=p;N(t,d,!1);L.add(d);l=new THREE.PlaneGeometry(5,50,2,50);e=new THREE.Mesh(l,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue.png?"+(new Date).getTime())}));e.frustumCulled=!1;e.position.set(0,1.2,0);e.userData=h;N(u,e,!1);L.add(e);ia({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){I=a;x.add(I)},drawCallback:function(a,
b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,12,8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(b.speed0)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";
a.fillText("Lap:"+Math.round(b.lap),125,84)}});h=document.createElement("canvas");h.width=h.height=20;p=new THREE.Texture(h);h=h.getContext("2d");g=1;h.lineWidth=g;h.lineJoin="miter";h.strokeStyle="white";h.beginPath();h.moveTo(g,g);h.lineTo(20-g,g);h.lineTo(20-g,20-g);h.lineTo(g,20-g);h.closePath();h.stroke();p.needsUpdate=!0;V=new THREE.SpriteMaterial({opacity:.6,map:p});for(b=0;b<a.particle.count;b++)p=new THREE.Sprite(V),p.position.copy(w(b/a.particle.count)).add(new THREE.Vector3(100*(Math.random()-
.5),10*(Math.random()-.5),100*(Math.random()-.5))),p.scale.multiplyScalar(.5+.3*Math.random()),x.add(p);s.position.set(m.initPosition.x,m.initPosition.y,m.initPosition.z);s.lookAt(w(0));window.addEventListener("resize",F,!1);document.addEventListener("mousemove",H,!1);$(y.domElement).click(function(a){k++;k>m.locations.length-1&&(n((q+1)%2),k=0)});$(E.domElement).click(function(a){if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=$(a.target).offset();a.offsetX=a.pageX-b.left;
a.offsetY=a.pageY-b.top}a=new THREE.Vector3(a.offsetX/$(this).width()*2-1,2*-(a.offsetY/$(this).height())+1,.5);a=P.pickingRay(a,D).intersectObjects(U);0<a.length&&n(a[0].object==t?0:1)});n(0);da();W&&W()})()}})}})}})})()};
