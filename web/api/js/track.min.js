(function(){function z(b){for(;1<b;)b--;for(;0>b;)b++;return b}function r(b){b=z(b);return I.getPointAt(b).add(u)}function R(b){b/=n;b=z(b);return I.getTangentAt(b)}function K(b,f,h){return b<=f?f:b>=h?h:b}function Y(b){for(var f=1,h=0;h<v.length;h++)b>=v[h]&&(f=(0==h%2?1:-1)*Math.cos(K((b-v[h])*Z,0,Math.PI)));return f}function J(b,f,h){b.position.copy(r(b.userData.distance/n));b=h;void 0===b&&(b=!0);for(h=0;h<f.geometry.vertices.length;h+=3){var d=f.userData.distance-aa*h/3*(f.userData.speed/S),
l=r(d/n),c=R(d).cross(new THREE.Vector3(0,1,0)),m=c.clone().multiplyScalar(f.userData.sideOffset*Y(50*z(d/n))),d=f.geometry.vertices[h+2],k=l.clone().add(m).add(c.clone().multiplyScalar(2));b?d.add(k.sub(d).multiplyScalar(A)):d.copy(k);d=f.geometry.vertices[h+1];k=l.clone().add(m);b?d.add(k.sub(d).multiplyScalar(A)):d.copy(k);d=f.geometry.vertices[h];l=l.clone().add(m).add(c.negate().multiplyScalar(2));b?d.add(l.sub(d).multiplyScalar(A)):d.copy(l)}f.geometry.verticesNeedUpdate=!0;f.geometry.boundingSphere=
null;f.geometry.boundingBox=null;T()}function ba(b){var f=new Image;f.onload=function(){var h=f.width,d=f.height,c=document.createElement("canvas");c.width=h;c.height=d;var m=new THREE.Texture(c),n=c.getContext("2d"),c=new THREE.SpriteMaterial({opacity:b.opacity,map:m});c.depthTest=!1;var k=new THREE.Sprite(c);k.updateInfo=function(c){n.drawImage(f,0,d*TYPES[c.userData.typeIndex].bgOffsetV,h,d/2,0,0,h,d/2);b.drawCallback&&b.drawCallback(n,c.userData);m.needsUpdate=!0;c=c.localToWorld(c.geometry.vertices[1].clone());
this.position.copy(c);this.scale.copy(k.scale0).multiplyScalar(p.position.distanceTo(c)*b.fixedScaleFactor)};k.scale.set(h/d*b.size,b.size,.1);k.scale0=k.scale.clone();k.visible=!1;b.finishCallback&&b.finishCallback(k)};f.src=b.imageUrl}function T(){B&&(B.visible=void 0!=s,s&&B.updateInfo(s))}var L,C,p,q,U,w,M,D,E,F,N=new THREE.Vector3(0,0,0),ca=new THREE.Vector3(0,0,0),V=0,W,O=window.innerWidth/2,I,u=new THREE.Vector3(0,0,0),n,P,G,x,y,t,c,m,aa=1,S,H,s,B,Q,v,A=.1,Z=10;$(function(b){b.ajax({url:"data/track.json",
type:"GET",async:!0,cache:!1,dataType:"json",success:function(f){var h=f.cameraFollow,d=0;v=f.sideShiftPercents;var l=f.svgFile;"/"!==l[0]&&(l="data/"+l);b.ajax({url:l,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(l){var v=b("g path",l.documentElement).attr("d");dataApi.getRaceData(function(k){if(0!=k.status)console.error("Data status invalid: "+k.message,k);else{l();X();var l=function(){L=document.getElementById("container");U=new THREE.Projector;w=new THREE.WebGLRenderer({alpha:!0,
antialias:!0});w.setClearColor(0,0);w.setSize(window.innerWidth,window.innerHeight);L.appendChild(w.domElement);q=new THREE.Scene;p=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3E6);M=new THREE.Clock;var a=transformSVGPath(v),b=a.getLength(),g=[],e;for(e in f.slopes){var d=f.slopes[e];g.push(new THREE.Vector3(d.percent/100*b,d.offset*f.slopeScale,0))}slopePathSplineCurve3=new THREE.ClosedSplineCurve3(g);a=a.getSpacedPoints(1500,!0);b=[];for(e=0;e<a.length;e++)b.push(new THREE.Vector3(a[e].x,
slopePathSplineCurve3.getPointAt(e/a.length).y,a[e].y));I=new THREE.ClosedSplineCurve3(b);n=I.getLength();P=1E3*f.trackLengthKM;G=P/n;S=P/(60*f.trackTimeMin)/G*2;a=new THREE.PlaneGeometry(7,n,1,1500);b=n/1500;for(e=0;e<a.vertices.length;e+=2){var d=b*e/2,g=r(d/n),d=R(d).cross(new THREE.Vector3(0,1,0)).clone().multiplyScalar(3),l=a.vertices[e+1];l.addVectors(g,d);l=a.vertices[e];l.addVectors(g,d.negate())}a.verticesNeedUpdate=!0;a.computeBoundingSphere();a.computeBoundingBox();u=a.boundingSphere.center.clone().negate();
e={name:k.data.weibo.name,distance:k.data.weibo.distance,rankings:k.data.weibo.rankings,lap:k.data.weibo.lap,speed:k.data.weibo.speed/G,sideOffset:2.5,typeIndex:k.data.weibo.typeIndex};b={name:k.data.twitter.name,distance:k.data.twitter.distance,rankings:k.data.twitter.rankings,lap:k.data.twitter.lap,speed:k.data.twitter.speed/G,sideOffset:-2.5,typeIndex:k.data.twitter.typeIndex};E=new THREE.Scene;meshMap=new THREE.Mesh(a.clone(),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}));
var g=a.boundingBox,d=g.max.x-g.min.x+200,l=g.max.z-g.min.z+200,g=200,s=l/d*g;meshMap.position.add(u);meshMap.matrixAutoUpdate=!1;meshMap.updateMatrix();E.add(meshMap);map=document.getElementById("map");F=new THREE.WebGLRenderer({alpha:!0,antialias:!0});F.setClearColor(0,0);F.setSize(g,s);map.appendChild(F.domElement);D=new THREE.OrthographicCamera(d/-2,d/2,l/2,l/-2,-500,2E3);D.position.set(0,1E3,0);D.up.set(0,0,-1);D.lookAt(new THREE.Vector3(0,0,0));x=new THREE.Mesh(new THREE.SphereGeometry(30),
new THREE.MeshBasicMaterial({color:16711680}));x.position.set(0,100,0);x.userData=e;E.add(x);y=new THREE.Mesh(new THREE.SphereGeometry(30),new THREE.MeshBasicMaterial({color:255}));y.position.set(0,100,0);y.userData=b;E.add(y);g=THREE.ImageUtils.loadTexture("image/track.png?"+(new Date).getTime());g.wrapS=g.wrapT=THREE.RepeatWrapping;g.repeat.set(1,50);t=new THREE.Mesh(a,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,map:g}));t.geometry.computeBoundingSphere();t.position.add(u);
t.matrixAutoUpdate=!1;t.updateMatrix();q.add(t);W=t.geometry.boundingSphere.radius;a=new THREE.CircleGeometry(3*W,50);a.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));a.vertices.shift();g=new THREE.Line(a,new THREE.LineBasicMaterial({color:10066329}));g.position.add(u);g.matrixAutoUpdate=!1;g.updateMatrix();q.add(g);a=a.clone();a.applyMatrix((new THREE.Matrix4).makeTranslation(0,20,0));a=new THREE.Line(a,new THREE.LineBasicMaterial({color:16777215}));a.position.add(u);a.matrixAutoUpdate=
!1;a.updateMatrix();q.add(a);H=new THREE.Object3D;q.add(H);a=new THREE.PlaneGeometry(5,50,2,50);c=new THREE.Mesh(a,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red.png?"+(new Date).getTime())}));c.frustumCulled=!1;c.position.set(0,1,0);c.matrixAutoUpdate=!1;c.updateMatrix();c.userData=e;J(x,c,!1);H.add(c);a=new THREE.PlaneGeometry(5,50,2,50);m=new THREE.Mesh(a,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,
side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue.png?"+(new Date).getTime())}));m.frustumCulled=!1;m.position.set(0,1.2,0);m.userData=b;J(y,m,!1);H.add(m);ba({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){B=a;q.add(B)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,
12,8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(b.speed*G*3600/1E3)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(b.lap),125,84)}});e=document.createElement("canvas");e.width=e.height=20;a=
new THREE.Texture(e);e=e.getContext("2d");g=1;e.lineWidth=g;e.lineJoin="miter";e.strokeStyle="white";e.beginPath();e.moveTo(g,g);e.lineTo(20-g,g);e.lineTo(20-g,20-g);e.lineTo(g,20-g);e.closePath();e.stroke();a.needsUpdate=!0;Q=new THREE.SpriteMaterial({opacity:.6,map:a});for(e=0;e<f.particle.count;e++)a=new THREE.Sprite(Q),a.position.copy(r(e/f.particle.count)).add(new THREE.Vector3(100*(Math.random()-.5),10*(Math.random()-.5),100*(Math.random()-.5))),a.scale.multiplyScalar(.5+.3*Math.random()),q.add(a);
p.position.set(h.initPosition.x,h.initPosition.y,h.initPosition.z);p.lookAt(r(0));window.addEventListener("resize",z,!1);document.addEventListener("mousemove",A,!1);document.addEventListener("click",K,!1);C=new Stats;C.domElement.style.position="absolute";C.domElement.style.top="0px";L.appendChild(C.domElement)},z=function(){O=window.innerWidth/2;p.aspect=window.innerWidth/window.innerHeight;p.updateProjectionMatrix();w.setSize(window.innerWidth,window.innerHeight)},A=function(a){V=a.clientX-O;if("undefined"===
typeof a.offsetX||"undefined"===typeof a.offsetY){var d=b(a.target).offset();a.offsetX=a.pageX-d.left;a.offsetY=a.pageY-d.top}a=new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);U.unprojectVector(a,p);a=(new THREE.Raycaster(p.position,a.sub(p.position).normalize())).intersectObjects(H.children);var c;0<a.length&&(c=a[0].object);c!=s&&(s=c,T())},K=function(a){d=(d+1)%h.locations.length},X=function(){requestAnimationFrame(X);var a=M.getDelta();c.userData.distance+=
a*(1+Math.random()/100)*c.userData.speed;c.userData.lap=Math.ceil(c.userData.distance/n);m.userData.distance+=a*(1+Math.random()/100)*m.userData.speed;m.userData.lap=Math.ceil(m.userData.distance/n);J(x,c);J(y,m);Math.max(c.userData.distance>m.userData.distance)?(a=c.userData.distance,c.userData.rankings=1,m.userData.rankings=2):(a=m.userData.distance,m.userData.rankings=1,c.userData.rankings=2);var b=r(a/n).add(ca);N.add(b.sub(N).multiplyScalar(h.lookAtFactor));b=h.locations[d];a=r((a+b.distance)/
n);b.height&&(a.y+=b.height);p.position.add(a.sub(p.position).multiplyScalar(h.followFactor));p.lookAt(N);a=new THREE.Vector3(V/O,1,0);p.up.add(a.sub(p.up).multiplyScalar(.05));Q.rotation=-M.getElapsedTime()*Math.PI*1.5;w.render(q,p);F.render(E,D);C.update()}}})}})}})})})();
