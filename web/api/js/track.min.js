function trackCreate(W){function F(a){for(;1<a;)a--;for(;0>a;)a++;return a}function X(a){for(;a>q;)a-=q;for(;0>a;)a+=q;return a}function w(a){a=F(a);return M.getPointAt(a).add(G)}function O(a){a/=q;a=F(a);return M.getTangentAt(a)}function ea(a,g,n){return a<=g?g:a>=n?n:a}function fa(a){for(var g=1,n=0;n<C.length;n++)a>=C[n]&&(g=(0==n%2?1:-1)*Math.cos(ea((a-C[n])*ga,0,Math.PI)));return g}function N(a,g,n){a.position.copy(w(a.userData.distance/q));a=n;void 0===a&&(a=!0);for(n=0;n<g.geometry.vertices.length;n+=
3){var l=g.userData.distance-ha*n/3*(1+.2*g.userData.faster),f=w(l/q),c=O(l).cross(new THREE.Vector3(0,1,0)),s=c.clone().multiplyScalar(g.userData.sideOffset*fa(50*F(l/q))),l=g.geometry.vertices[n+2],e=f.clone().add(s).add(c.clone().multiplyScalar(2));a?l.add(e.sub(l).multiplyScalar(H)):l.copy(e);l=g.geometry.vertices[n+1];e=f.clone().add(s);a?l.add(e.sub(l).multiplyScalar(H)):l.copy(e);l=g.geometry.vertices[n];f=f.clone().add(s).add(c.negate().multiplyScalar(2));a?l.add(f.sub(l).multiplyScalar(H)):
l.copy(f)}g.geometry.verticesNeedUpdate=!0;g.geometry.boundingSphere=null;g.geometry.boundingBox=null;Y()}function ia(a){var g=new Image;g.onload=function(){var f=g.width,l=g.height,c=document.createElement("canvas");c.width=f;c.height=l;var q=new THREE.Texture(c),t=c.getContext("2d");p=new THREE.SpriteMaterial({opacity:a.opacity,map:q});p.depthTest=!1;p.opacity0=p.opacity;var e=new THREE.Sprite(p);e.updateInfo=function(c){t.drawImage(g,0,l*TYPES[c.userData.typeIndex].bgOffsetV/2,f,l/2,0,0,f,l/2);
a.drawCallback&&a.drawCallback(t,c.userData);q.needsUpdate=!0;c=c.localToWorld(c.geometry.vertices[1].clone());this.position.copy(c);this.scale.copy(e.scale0).multiplyScalar(s.position.distanceTo(c)*a.fixedScaleFactor)};e.scale.set(f/l*a.size,a.size,.1);e.scale0=e.scale.clone();e.visible=!1;a.finishCallback&&a.finishCallback(e)};g.src=a.imageUrl}function Y(){I&&(I.visible=void 0!=J,J?(I.updateInfo(J),p.opacity+=.03,p.opacity>p.opacity0&&(p.opacity=p.opacity0)):p.opacity=0)}var Z,s,x,P,y,Q,D,K,E,R=
new THREE.Vector3(0,0,0),ja=new THREE.Vector3(0,0,0),aa=0,ba,S=window.innerWidth/2,M,G=new THREE.Vector3(0,0,0),q,ca,T,t,u,z,f,c,ha=1,L,J,U=[],I,p,V,C,H=.1,ga=10;(function(){$.ajax({url:"data/track.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var g=a.cameraFollow,n=0,l=0;C=a.sideShiftPercents;var p=a.svgFile;"/"!==p[0]&&(p="data/"+p);$.ajax({url:p,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(p){var C=$("g path",p.documentElement).attr("d");dataApi.getRaceData(function(e){if(0!=
e.status)console.error("Data status invalid: "+e.message,e);else{var p=function(a){l=a;t.hilight.visible=0==l;u.hilight.visible=1==l},F=function(){S=window.innerWidth/2;s.aspect=window.innerWidth/window.innerHeight;s.updateProjectionMatrix();y.setSize(window.innerWidth,window.innerHeight)},H=function(a){aa=a.clientX-S;if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var d=$(a.target).offset();a.offsetX=a.pageX-d.left;a.offsetY=a.pageY-d.top}a=new THREE.Vector3(a.offsetX/window.innerWidth*
2-1,2*-(a.offsetY/window.innerHeight)+1,.5);P.unprojectVector(a,s);a=(new THREE.Raycaster(s.position,a.sub(s.position).normalize())).intersectObjects(L.children);var c;0<a.length&&(c=a[0].object);c!=J&&(J=c,Y())},da=function(){requestAnimationFrame(da);var a=Q.getDelta();f.userData.distance+=a*f.userData.speed;f.userData.distance1+=a*f.userData.speed;f.userData.lap=f.userData.lap0+Math.floor(f.userData.distance1/q);c.userData.distance+=a*c.userData.speed;c.userData.distance1+=a*c.userData.speed;c.userData.lap=
c.userData.lap0+Math.floor(c.userData.distance1/q);N(t,f);N(u,c);Math.max(f.userData.distance>c.userData.distance)?(f.userData.rankings=1,c.userData.rankings=2):(c.userData.rankings=1,f.userData.rankings=2);var a=(0==l?f:c).userData.distance,d=w(a/q).add(ja);R.add(d.sub(R).multiplyScalar(g.lookAtFactor));d=g.locations[n];a=w((a+d.distance)/q);d.height&&(a.y+=d.height);s.position.add(a.sub(s.position).multiplyScalar(g.followFactor));s.lookAt(R);a=new THREE.Vector3(aa/S,1,0);s.up.add(a.sub(s.up).multiplyScalar(.05));
V.rotation=-Q.getElapsedTime()*Math.PI*1.5;y.render(x,s);E.render(K,D)};(function(){Z=document.getElementById("container");P=new THREE.Projector;y=new THREE.WebGLRenderer({alpha:!0,antialias:!0});y.setClearColor(0,0);y.setSize(window.innerWidth,window.innerHeight);Z.appendChild(y.domElement);x=new THREE.Scene;s=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3E6);Q=new THREE.Clock;var m=transformSVGPath(C),d=m.getLength(),k=[],b;for(b in a.slopes){var h=a.slopes[b];k.push(new THREE.Vector3(h.percent/
100*d,h.offset*a.slopeScale,0))}slopePathSplineCurve3=new THREE.ClosedSplineCurve3(k);m=m.getSpacedPoints(1500,!0);d=[];for(b=0;b<m.length;b++)d.push(new THREE.Vector3(m[b].x,slopePathSplineCurve3.getPointAt(b/m.length).y,m[b].y));M=new THREE.ClosedSplineCurve3(d);q=M.getLength();ca=1E3*a.trackLengthKM;T=ca/q;var k=new THREE.PlaneGeometry(7,q,1,1500),A=q/1500;for(b=0;b<k.vertices.length;b+=2){var r=A*b/2,v=w(r/q),r=O(r),r=r.cross(new THREE.Vector3(0,1,0)),r=r.clone().multiplyScalar(3),B=k.vertices[b+
1];B.addVectors(v,r);B=k.vertices[b];B.addVectors(v,r.negate())}k.verticesNeedUpdate=!0;k.computeBoundingSphere();k.computeBoundingBox();G=k.boundingSphere.center.clone().negate();m={name:e.data.weibo.name,distance:e.data.weibo.distance,rankings:e.data.weibo.rankings,lap:e.data.weibo.lap,sideOffset:2.5,typeIndex:e.data.weibo.typeIndex};m.speed0=e.data.weibo.speed;m.distance1=X(m.distance);m.lap0=m.lap;d={name:e.data.twitter.name,distance:e.data.twitter.distance,rankings:e.data.twitter.rankings,lap:e.data.twitter.lap,
sideOffset:-2.5,typeIndex:e.data.twitter.typeIndex};d.speed0=e.data.twitter.speed;d.distance1=X(d.distance);d.lap0=d.lap;b=1;150>e.data.weibo.speed&&150>e.data.twitter.speed&&(b=150/Math.max(e.data.weibo.speed,e.data.twitter.speed));m.speed=e.data.weibo.speed*b*1E3/60/60/T;d.speed=e.data.twitter.speed*b*1E3/60/60/T;Math.max(m.speed0>d.speed0)?(m.faster=1,d.faster=0):(m.faster=0,d.faster=1);K=new THREE.Scene;h=new THREE.PlaneGeometry(7,q,1,1500);A=q/1500;for(b=0;b<h.vertices.length;b+=2)r=A*b/2,v=
w(r/q),r=O(r),r=r.cross(new THREE.Vector3(0,3,0)),r=r.clone().multiplyScalar(3),B=h.vertices[b+1],B.addVectors(v,r),B=h.vertices[b],B.addVectors(v,r.negate());h.verticesNeedUpdate=!0;h.computeBoundingSphere();h.computeBoundingBox();b=h.boundingSphere.center.clone().negate();meshMap=new THREE.Mesh(h,new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}));h=h.boundingBox;A=h.max.x-h.min.x+200;v=h.max.z-h.min.z+200;h=200;r=v/A*h;meshMap.position.add(b);meshMap.matrixAutoUpdate=!1;meshMap.updateMatrix();
K.add(meshMap);map=document.getElementById("map");E=new THREE.WebGLRenderer({alpha:!0,antialias:!0});E.setClearColor(0,0);E.setSize(h,r);map.appendChild(E.domElement);D=new THREE.OrthographicCamera(A/-2,A/2,v/2,v/-2,-500,2E3);D.position.set(0,1E3,0);D.up.set(0,0,-1);D.lookAt(new THREE.Vector3(0,0,0));t=new THREE.Mesh(new THREE.SphereGeometry(30,20,1),new THREE.MeshBasicMaterial({color:16711680}));t.position.set(0,100,0);t.userData=m;K.add(t);U.push(t);b=t.clone();b.material=new THREE.MeshBasicMaterial({color:TYPES[0].color,
transparent:!0,opacity:.5});b.scale.set(3,3,3);b.visible=!1;t.add(b);t.hilight=b;u=new THREE.Mesh(new THREE.SphereGeometry(30,20,1),new THREE.MeshBasicMaterial({color:255}));u.position.set(0,100,0);u.userData=d;K.add(u);U.push(u);b=u.clone();b.material=new THREE.MeshBasicMaterial({color:TYPES[1].color,transparent:!0,opacity:.5});b.scale.set(3,3,3);b.visible=!1;u.add(b);u.hilight=b;b=THREE.ImageUtils.loadTexture("image/track.png?"+(new Date).getTime());b.wrapS=b.wrapT=THREE.RepeatWrapping;b.repeat.set(1,
50);z=new THREE.Mesh(k,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,map:b}));z.geometry.computeBoundingSphere();z.position.add(G);z.matrixAutoUpdate=!1;z.updateMatrix();x.add(z);ba=z.geometry.boundingSphere.radius;k=new THREE.CircleGeometry(3*ba,50);k.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));k.vertices.shift();b=new THREE.Line(k,new THREE.LineBasicMaterial({color:10066329}));b.position.add(G);b.matrixAutoUpdate=!1;b.updateMatrix();x.add(b);k=k.clone();
k.applyMatrix((new THREE.Matrix4).makeTranslation(0,20,0));k=new THREE.Line(k,new THREE.LineBasicMaterial({color:16777215}));k.position.add(G);k.matrixAutoUpdate=!1;k.updateMatrix();x.add(k);L=new THREE.Object3D;x.add(L);k=new THREE.PlaneGeometry(5,50,2,50);f=new THREE.Mesh(k,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red.png?"+(new Date).getTime())}));f.frustumCulled=!1;f.position.set(0,1,0);f.matrixAutoUpdate=
!1;f.updateMatrix();f.userData=m;N(t,f,!1);L.add(f);k=new THREE.PlaneGeometry(5,50,2,50);c=new THREE.Mesh(k,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue.png?"+(new Date).getTime())}));c.frustumCulled=!1;c.position.set(0,1.2,0);c.userData=d;N(u,c,!1);L.add(c);ia({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){I=a;x.add(I)},drawCallback:function(a,
b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,12,8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(b.speed0)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";
a.fillText("Lap:"+Math.round(b.lap),125,84)}});d=document.createElement("canvas");d.width=d.height=20;m=new THREE.Texture(d);d=d.getContext("2d");h=1;d.lineWidth=h;d.lineJoin="miter";d.strokeStyle="white";d.beginPath();d.moveTo(h,h);d.lineTo(20-h,h);d.lineTo(20-h,20-h);d.lineTo(h,20-h);d.closePath();d.stroke();m.needsUpdate=!0;V=new THREE.SpriteMaterial({opacity:.6,map:m});for(b=0;b<a.particle.count;b++)m=new THREE.Sprite(V),m.position.copy(w(b/a.particle.count)).add(new THREE.Vector3(100*(Math.random()-
.5),10*(Math.random()-.5),100*(Math.random()-.5))),m.scale.multiplyScalar(.5+.3*Math.random()),x.add(m);s.position.set(g.initPosition.x,g.initPosition.y,g.initPosition.z);s.lookAt(w(0));window.addEventListener("resize",F,!1);document.addEventListener("mousemove",H,!1);$(y.domElement).click(function(a){n++;n>g.locations.length-1&&(p((l+1)%2),n=0)});$(E.domElement).click(function(a){if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=$(a.target).offset();a.offsetX=a.pageX-b.left;
a.offsetY=a.pageY-b.top}a=new THREE.Vector3(a.offsetX/$(this).width()*2-1,2*-(a.offsetY/$(this).height())+1,.5);a=P.pickingRay(a,D).intersectObjects(U);0<a.length&&p(a[0].object==t?0:1)});p(0);da();W&&W()})()}})}})}})})()};
