(function(){function z(b){for(;1<b;)b--;for(;0>b;)b++;return b}function r(b){b=z(b);return G.getPointAt(b).add(u)}function O(b){b/=n;b=z(b);return G.getTangentAt(b)}function J(b,g,k){return b<=g?g:b>=k?k:b}function W(b){for(var g=1,k=0;k<p.length;k++)b>=p[k]&&(g=(0==k%2?1:-1)*Math.cos(J((b-p[k])*X,0,Math.PI)));return g}function H(b,g,k){b.position.copy(r(b.userData.distance/n));b=k;void 0===b&&(b=!0);for(k=0;k<g.geometry.vertices.length;k+=3){var h=g.userData.distance-Y*k/3*(1+.2*g.userData.faster),
f=r(h/n),c=O(h).cross(new THREE.Vector3(0,1,0)),m=c.clone().multiplyScalar(g.userData.sideOffset*W(50*z(h/n))),h=g.geometry.vertices[k+2],l=f.clone().add(m).add(c.clone().multiplyScalar(2));b?h.add(l.sub(h).multiplyScalar(A)):h.copy(l);h=g.geometry.vertices[k+1];l=f.clone().add(m);b?h.add(l.sub(h).multiplyScalar(A)):h.copy(l);h=g.geometry.vertices[k];f=f.clone().add(m).add(c.negate().multiplyScalar(2));b?h.add(f.sub(h).multiplyScalar(A)):h.copy(f)}g.geometry.verticesNeedUpdate=!0;g.geometry.boundingSphere=
null;g.geometry.boundingBox=null;P()}function Z(b){var g=new Image;g.onload=function(){var k=g.width,f=g.height,c=document.createElement("canvas");c.width=k;c.height=f;var n=new THREE.Texture(c),q=c.getContext("2d"),c=new THREE.SpriteMaterial({opacity:b.opacity,map:n});c.depthTest=!1;var l=new THREE.Sprite(c);l.updateInfo=function(c){q.drawImage(g,0,f*TYPES[c.userData.typeIndex].bgOffsetV,k,f/2,0,0,k,f/2);b.drawCallback&&b.drawCallback(q,c.userData);n.needsUpdate=!0;c=c.localToWorld(c.geometry.vertices[1].clone());
this.position.copy(c);this.scale.copy(l.scale0).multiplyScalar(m.position.distanceTo(c)*b.fixedScaleFactor)};l.scale.set(k/f*b.size,b.size,.1);l.scale0=l.scale.clone();l.visible=!1;b.finishCallback&&b.finishCallback(l)};g.src=b.imageUrl}function P(){B&&(B.visible=void 0!=s,s&&B.updateInfo(s))}var Q,m,q,R,w,K,C,D,E,L=new THREE.Vector3(0,0,0),aa=new THREE.Vector3(0,0,0),S=0,T,M=window.innerWidth/2,G,u=new THREE.Vector3(0,0,0),n,U,I,x,y,t,f,c,Y=1,F,s,B,N,p,A=.1,X=10;$(function(b){b.ajax({url:"data/track.json",
type:"GET",async:!0,cache:!1,dataType:"json",success:function(g){var k=g.cameraFollow,h=0;p=g.sideShiftPercents;var v=g.svgFile;"/"!==v[0]&&(v="data/"+v);b.ajax({url:v,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(p){var v=b("g path",p.documentElement).attr("d");dataApi.getRaceData(function(l){if(0!=l.status)console.error("Data status invalid: "+l.message,l);else{p();V();var p=function(){Q=document.getElementById("container");R=new THREE.Projector;w=new THREE.WebGLRenderer({alpha:!0,
antialias:!0});w.setClearColor(0,0);w.setSize(window.innerWidth,window.innerHeight);Q.appendChild(w.domElement);q=new THREE.Scene;m=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3E6);K=new THREE.Clock;var a=transformSVGPath(v),b=a.getLength(),e=[],d;for(d in g.slopes){var h=g.slopes[d];e.push(new THREE.Vector3(h.percent/100*b,h.offset*g.slopeScale,0))}slopePathSplineCurve3=new THREE.ClosedSplineCurve3(e);a=a.getSpacedPoints(1500,!0);b=[];for(d=0;d<a.length;d++)b.push(new THREE.Vector3(a[d].x,
slopePathSplineCurve3.getPointAt(d/a.length).y,a[d].y));G=new THREE.ClosedSplineCurve3(b);n=G.getLength();U=1E3*g.trackLengthKM;I=U/n;a=new THREE.PlaneGeometry(7,n,1,1500);b=n/1500;for(d=0;d<a.vertices.length;d+=2){var h=b*d/2,e=r(h/n),h=O(h).cross(new THREE.Vector3(0,1,0)).clone().multiplyScalar(3),p=a.vertices[d+1];p.addVectors(e,h);p=a.vertices[d];p.addVectors(e,h.negate())}a.verticesNeedUpdate=!0;a.computeBoundingSphere();a.computeBoundingBox();u=a.boundingSphere.center.clone().negate();d={name:l.data.weibo.name,
distance:l.data.weibo.distance,rankings:l.data.weibo.rankings,lap:l.data.weibo.lap,speed:1E3*l.data.weibo.speed/60/60/I,sideOffset:2.5,typeIndex:l.data.weibo.typeIndex,faster:0};b={name:l.data.twitter.name,distance:l.data.twitter.distance,rankings:l.data.twitter.rankings,lap:l.data.twitter.lap,speed:1E3*l.data.twitter.speed/60/60/I,sideOffset:-2.5,typeIndex:l.data.twitter.typeIndex,faster:0};D=new THREE.Scene;meshMap=new THREE.Mesh(a.clone(),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}));
var e=a.boundingBox,h=e.max.x-e.min.x+200,p=e.max.z-e.min.z+200,e=200,s=p/h*e;meshMap.position.add(u);meshMap.matrixAutoUpdate=!1;meshMap.updateMatrix();D.add(meshMap);map=document.getElementById("map");E=new THREE.WebGLRenderer({alpha:!0,antialias:!0});E.setClearColor(0,0);E.setSize(e,s);map.appendChild(E.domElement);C=new THREE.OrthographicCamera(h/-2,h/2,p/2,p/-2,-500,2E3);C.position.set(0,1E3,0);C.up.set(0,0,-1);C.lookAt(new THREE.Vector3(0,0,0));x=new THREE.Mesh(new THREE.SphereGeometry(30),
new THREE.MeshBasicMaterial({color:16711680}));x.position.set(0,100,0);x.userData=d;D.add(x);y=new THREE.Mesh(new THREE.SphereGeometry(30),new THREE.MeshBasicMaterial({color:255}));y.position.set(0,100,0);y.userData=b;D.add(y);e=THREE.ImageUtils.loadTexture("image/track.png?"+(new Date).getTime());e.wrapS=e.wrapT=THREE.RepeatWrapping;e.repeat.set(1,50);t=new THREE.Mesh(a,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,map:e}));t.geometry.computeBoundingSphere();t.position.add(u);
t.matrixAutoUpdate=!1;t.updateMatrix();q.add(t);T=t.geometry.boundingSphere.radius;a=new THREE.CircleGeometry(3*T,50);a.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));a.vertices.shift();e=new THREE.Line(a,new THREE.LineBasicMaterial({color:10066329}));e.position.add(u);e.matrixAutoUpdate=!1;e.updateMatrix();q.add(e);a=a.clone();a.applyMatrix((new THREE.Matrix4).makeTranslation(0,20,0));a=new THREE.Line(a,new THREE.LineBasicMaterial({color:16777215}));a.position.add(u);a.matrixAutoUpdate=
!1;a.updateMatrix();q.add(a);F=new THREE.Object3D;q.add(F);a=new THREE.PlaneGeometry(5,50,2,50);f=new THREE.Mesh(a,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red.png?"+(new Date).getTime())}));f.frustumCulled=!1;f.position.set(0,1,0);f.matrixAutoUpdate=!1;f.updateMatrix();f.userData=d;H(x,f,!1);F.add(f);a=new THREE.PlaneGeometry(5,50,2,50);c=new THREE.Mesh(a,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,
side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue.png?"+(new Date).getTime())}));c.frustumCulled=!1;c.position.set(0,1.2,0);c.userData=b;H(y,c,!1);F.add(c);Z({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){B=a;q.add(B)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,12,
8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(b.speed*I*3600/1E3)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(b.lap),125,84)}});d=document.createElement("canvas");d.width=d.height=20;a=new THREE.Texture(d);
d=d.getContext("2d");e=1;d.lineWidth=e;d.lineJoin="miter";d.strokeStyle="white";d.beginPath();d.moveTo(e,e);d.lineTo(20-e,e);d.lineTo(20-e,20-e);d.lineTo(e,20-e);d.closePath();d.stroke();a.needsUpdate=!0;N=new THREE.SpriteMaterial({opacity:.6,map:a});for(d=0;d<g.particle.count;d++)a=new THREE.Sprite(N),a.position.copy(r(d/g.particle.count)).add(new THREE.Vector3(100*(Math.random()-.5),10*(Math.random()-.5),100*(Math.random()-.5))),a.scale.multiplyScalar(.5+.3*Math.random()),q.add(a);m.position.set(k.initPosition.x,
k.initPosition.y,k.initPosition.z);m.lookAt(r(0));window.addEventListener("resize",z,!1);document.addEventListener("mousemove",A,!1);document.addEventListener("click",J,!1)},z=function(){M=window.innerWidth/2;m.aspect=window.innerWidth/window.innerHeight;m.updateProjectionMatrix();w.setSize(window.innerWidth,window.innerHeight)},A=function(a){S=a.clientX-M;if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var c=b(a.target).offset();a.offsetX=a.pageX-c.left;a.offsetY=a.pageY-c.top}a=
new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);R.unprojectVector(a,m);a=(new THREE.Raycaster(m.position,a.sub(m.position).normalize())).intersectObjects(F.children);var e;0<a.length&&(e=a[0].object);e!=s&&(s=e,P())},J=function(a){h=(h+1)%k.locations.length},V=function(){requestAnimationFrame(V);var a=K.getDelta();f.userData.distance+=a*f.userData.speed;f.userData.lap=Math.ceil(f.userData.distance/n);c.userData.distance+=a*c.userData.speed;c.userData.lap=
Math.ceil(c.userData.distance/n);H(x,f);H(y,c);Math.max(f.userData.distance>c.userData.distance)?(a=f.userData.distance,f.userData.rankings=1,c.userData.rankings=2):(a=c.userData.distance,c.userData.rankings=1,f.userData.rankings=2);Math.max(f.userData.speed>c.userData.speed)?(f.userData.faster=1,c.userData.faster=0):(f.userData.faster=0,c.userData.faster=1);var b=r(a/n).add(aa);L.add(b.sub(L).multiplyScalar(k.lookAtFactor));b=k.locations[h];a=r((a+b.distance)/n);b.height&&(a.y+=b.height);m.position.add(a.sub(m.position).multiplyScalar(k.followFactor));
m.lookAt(L);a=new THREE.Vector3(S/M,1,0);m.up.add(a.sub(m.up).multiplyScalar(.05));N.rotation=-K.getElapsedTime()*Math.PI*1.5;w.render(q,m);E.render(D,C)}}})}})}})})})();
