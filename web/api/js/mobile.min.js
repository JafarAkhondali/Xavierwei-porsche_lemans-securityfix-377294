function trackCreate(E){function F(a){for(;1<a;)a--;for(;0>a;)a++;return a}function G(a){for(;a>h;)a-=h;for(;0>a;)a+=h;return a}function H(a){a/=h;a=F(a);return y.getPointAt(a).add(B)}function I(a){a/=h;a=F(a);return y.getTangentAt(a)}function z(a,b){void 0===b&&(b=!0);for(var c=0;c<a.geometry.vertices.length;c+=3){var f=a.userData.distance-O*c/3*(5+.2*a.userData.faster),e=H(f),m=I(f).cross(new THREE.Vector3(0,10,0)),h=m.clone().multiplyScalar(1.6*a.userData.sideOffset),f=a.geometry.vertices[c+2],
l=e.clone().add(h).add(m.clone().multiplyScalar(2));b?f.add(l.sub(f).multiplyScalar(u)):f.copy(l);f=a.geometry.vertices[c+1];l=e.clone().add(h);b?f.add(l.sub(f).multiplyScalar(u)):f.copy(l);f=a.geometry.vertices[c];e=e.clone().add(h).add(m.negate().multiplyScalar(2));b?f.add(e.sub(f).multiplyScalar(u)):f.copy(e)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;J()}function P(a){var b=new Image;b.onload=function(){var c=b.width,f=b.height,e=document.createElement("canvas");
e.width=c;e.height=f;var h=new THREE.Texture(e),n=e.getContext("2d"),e=new THREE.SpriteMaterial({opacity:a.opacity,map:h});e.depthTest=!1;var l=new THREE.Sprite(e);l.updateInfo=function(d){n.drawImage(b,0,f*TYPES[d.userData.typeIndex].bgOffsetV,c,f/2,0,0,c,f/2);a.drawCallback&&a.drawCallback(n,d.userData);h.needsUpdate=!0;d=d.localToWorld(d.geometry.vertices[1].clone().setY(100));this.position.copy(d);this.scale.copy(l.scale0).multiplyScalar(m.position.distanceTo(d)*a.fixedScaleFactor)};l.scale.set(c/
f*a.size,a.size,.1);l.scale0=l.scale.clone();l.visible=!1;a.finishCallback&&a.finishCallback(l)};b.src=a.imageUrl}function J(){v&&(v.visible=void 0!=p,p&&v.updateInfo(p))}var K,m,w,L,s,M,C,D,y,B=new THREE.Vector3(0,0,0),h,N,A,n,b,c,O=1,x,p,v,u=.1;(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var q=a.svgFile;"/"!==q[0]&&(q="data/"+q);$.ajax({url:q,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(q){var f=$("g path",q.documentElement).attr("d");
dataApi.getRaceData(function(e){if(0!=e.status)console.error("Data status invalid: "+e.message,e);else{var q=function(){var d=window.innerWidth-200,a=window.innerHeight-200,b=Math.min(d/C,a/D);m.left=d/b/-2-100/b;m.right=d/b/2+100/b;m.top=a/b/2+100/b;m.bottom=a/b/-2-100/b;m.updateProjectionMatrix();s.setSize(window.innerWidth,window.innerHeight)},u=function(a){if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=$(a.target).offset();a.offsetX=a.pageX-b.left;a.offsetY=a.pageY-b.top}a=
new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);a=L.pickingRay(a,m).intersectObjects(x.children);var c;0<a.length&&(c=a[0].object);c!=p&&(p=c,J())},l=function(){requestAnimationFrame(l);var a=M.getDelta();b.userData.distance+=a*b.userData.speed;b.userData.distance1+=a*b.userData.speed;b.userData.lap=b.userData.lap0+Math.floor(b.userData.distance1/h);c.userData.distance+=a*c.userData.speed;c.userData.distance1+=a*c.userData.speed;c.userData.lap=c.userData.lap0+
Math.floor(c.userData.distance1/h);z(b,void 0);z(c,void 0);Math.max(b.userData.distance>c.userData.distance)?(followDistance=b.userData.distance,b.userData.rankings=1,c.userData.rankings=2):(followDistance=c.userData.distance,c.userData.rankings=1,b.userData.rankings=2);Math.max(b.userData.speed>c.userData.speed)?(b.userData.faster=1,c.userData.faster=0):(b.userData.faster=0,c.userData.faster=1);s.render(w,m)};(function(){K=document.getElementById("container");L=new THREE.Projector;s=new THREE.CanvasRenderer({alpha:!0});
s.setClearColor(0,0);s.setSize(window.innerWidth,window.innerHeight);K.appendChild(s.domElement);w=new THREE.Scene;M=new THREE.Clock;for(var d=transformSVGPath(f).getSpacedPoints(1E3,!0),g=[],k=0;k<d.length;k++)g.push(new THREE.Vector3(d[k].x,0,d[k].y));y=new THREE.ClosedSplineCurve3(g);h=y.getLength();N=1E3*a.trackLengthKM;A=N/h;for(var d=new THREE.PlaneGeometry(7,h,1,1E3),r=h/1E3,k=0;k<d.vertices.length;k+=2){var g=r*k/2,t=H(g),g=I(g).cross(new THREE.Vector3(0,a.trackWidth,0)).clone().multiplyScalar(3),
p=d.vertices[k+1];p.addVectors(t,g);p=d.vertices[k];p.addVectors(t,g.negate())}d.verticesNeedUpdate=!0;d.applyMatrix((new THREE.Matrix4).makeRotationY(a.rotate/180*Math.PI));d.computeBoundingSphere();d.computeBoundingBox();k={name:e.data.weibo.name,distance:e.data.weibo.distance,rankings:e.data.weibo.rankings,lap:e.data.weibo.lap,speed:1E3*e.data.weibo.speed/60/60/A,sideOffset:2.5,typeIndex:e.data.weibo.typeIndex,faster:0};k.distance1=G(k.distance);k.lap0=k.lap;r={name:e.data.twitter.name,distance:e.data.twitter.distance,
rankings:e.data.twitter.rankings,lap:e.data.twitter.lap,speed:1E3*e.data.twitter.speed/60/60/A,sideOffset:-2.5,typeIndex:e.data.twitter.typeIndex,faster:0};r.distance1=G(r.distance);r.lap0=r.lap;g=d.boundingBox;C=g.max.x-g.min.x;D=g.max.z-g.min.z;d.applyMatrix((new THREE.Matrix4).makeRotationY(-a.rotate/180*Math.PI));n=new THREE.Mesh(d,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));n.geometry.computeBoundingBox();n.geometry.computeBoundingSphere();B=d.boundingSphere.center.clone().negate();
n.position.add(B);n.matrixAutoUpdate=!1;n.updateMatrix();w.add(n);d=window.innerWidth-200;t=window.innerHeight-200;g=Math.min(d/C,t/D);m=new THREE.OrthographicCamera(d/g/-2-100/g,d/g/2+100/g,t/g/2+100/g,t/g/-2-100/g,-500,2E3);m.position.set(0,1E3,0);m.up.set(1.42,1,-1).normalize();m.lookAt(new THREE.Vector3(0,0,0));x=new THREE.Object3D;w.add(x);d=new THREE.PlaneGeometry(5,50,2,50);b=new THREE.Mesh(d,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red-mobile.png?"+
(new Date).getTime())}));b.frustumCulled=!1;b.position.set(0,1,0);b.matrixAutoUpdate=!1;b.updateMatrix();b.userData=k;z(b,!1);x.add(b);d=new THREE.PlaneGeometry(5,50,2,50);c=new THREE.Mesh(d,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue-mobile.png?"+(new Date).getTime())}));c.frustumCulled=!1;c.position.set(0,1.2,0);c.userData=r;z(c,!1);x.add(c);P({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,
size:15,fixedScaleFactor:.015,finishCallback:function(a){v=a;w.add(v)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,12,8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";
a.fillText(""+Math.round(b.speed*A*3600/1E3)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(b.lap),125,84)}});window.addEventListener("resize",q,!1);document.addEventListener("click",u,!1);l();E&&E()})()}})}})}})})()};
