function trackCreate(F){function G(a){for(;1<a;)a--;for(;0>a;)a++;return a}function H(a){for(;a>k;)a-=k;for(;0>a;)a+=k;return a}function I(a){a/=k;a=G(a);return x.getPointAt(a).add(B)}function J(a){a/=k;a=G(a);return x.getTangentAt(a)}function y(a,b){void 0===b&&(b=!0);for(var c=0;c<a.geometry.vertices.length;c+=3){var h=a.userData.distance-O*c/3*(5+.2*a.userData.faster),d=I(h),l=J(h).cross(new THREE.Vector3(0,10,0));0==c&&(a.side=l.clone().multiplyScalar(a.userData.infoBoxSide));var k=l.clone().multiplyScalar(1.6*
a.userData.sideOffset),h=a.geometry.vertices[c+2],m=d.clone().add(k).add(l.clone().multiplyScalar(2));b?h.add(m.sub(h).multiplyScalar(v)):h.copy(m);h=a.geometry.vertices[c+1];m=d.clone().add(k);b?h.add(m.sub(h).multiplyScalar(v)):h.copy(m);h=a.geometry.vertices[c];d=d.clone().add(k).add(l.negate().multiplyScalar(2));b?h.add(d.sub(h).multiplyScalar(v)):h.copy(d)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;K()}function P(a){var b=new Image;b.onload=function(){var c=
b.width/4,h=b.height/2,d=document.createElement("canvas");d.width=2*c;d.height=2*h;var k=new THREE.Texture(d),p=d.getContext("2d"),m=new THREE.SpriteMaterial({opacity:a.opacity,map:k});m.depthTest=!1;var f=new THREE.Sprite(m);f.updateInfo=function(e){var g=Q,n=Math.atan2(e.side.x,e.side.z),g=g[Math.floor((n+Math.PI/4)/(Math.PI/2)+4)%4],n=c*g.x,m=h*g.y;p.clearRect(0,0,d.width,d.height);p.drawImage(b,c*g.wo,h*TYPES[e.userData.typeIndex].bgOffsetV,c,h,n,m,c,h);a.drawCallback&&a.drawCallback(p,n+13,m+
13,e.userData);k.needsUpdate=!0;e=e.localToWorld(e.geometry.vertices[3*(z-10)+1+e.userData.infoBoxSide].clone().setY(100));this.position.copy(e);this.scale.copy(f.scale0).multiplyScalar(l.position.distanceTo(e)*a.fixedScaleFactor)};f.scale.set(c/h*a.size,a.size,.1);f.scale0=f.scale.clone();f.visible=!1;a.finishCallback&&a.finishCallback(f)};b.src=a.imageUrl}function K(){w&&(w.visible=void 0!=q,q&&w.updateInfo(q))}var L,l,u,p,M,C,D,x,B=new THREE.Vector3(0,0,0),k,N,E,s,b,c,z=50,O=50/z,A,q,w,v=.1,Q=
[{wo:1,x:1,y:.5},{wo:0,x:.5,y:0},{wo:3,x:0,y:.5},{wo:2,x:.5,y:1}];(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var r=a.svgFile;"/"!==r[0]&&(r="data/"+r);$.ajax({url:r,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(r){var h=$("g path",r.documentElement).attr("d");dataApi.getRaceData(function(d){if(0!=d.status)console.error("Data status invalid: "+d.message,d);else{var r=function(){var a=window.innerWidth-200,c=window.innerHeight-
200,b=Math.min(a/C,c/D);l.left=a/b/-2-100/b;l.right=a/b/2+100/b;l.top=c/b/2+100/b;l.bottom=c/b/-2-100/b;l.updateProjectionMatrix();p.setSize(window.innerWidth,window.innerHeight)},v=function(a){q=q==b?c:b;K();p.render(u,l)},m=function(){requestAnimationFrame(m);var a=M.getDelta();b.userData.distance+=a*b.userData.speed;b.userData.distance1+=a*b.userData.speed;b.userData.lap=b.userData.lap0+Math.floor(b.userData.distance1/k);c.userData.distance+=a*c.userData.speed;c.userData.distance1+=a*c.userData.speed;
c.userData.lap=c.userData.lap0+Math.floor(c.userData.distance1/k);y(b,void 0);y(c,void 0);Math.max(b.userData.distance>c.userData.distance)?(followDistance=b.userData.distance,b.userData.rankings=1,c.userData.rankings=2):(followDistance=c.userData.distance,c.userData.rankings=1,b.userData.rankings=2);Math.max(b.userData.speed>c.userData.speed)?(b.userData.faster=1,c.userData.faster=0):(b.userData.faster=0,c.userData.faster=1);p.render(u,l)};(function(){L=document.getElementById("container");new THREE.Projector;
p=new THREE.CanvasRenderer({alpha:!0});p.setClearColor(0,0);p.setSize(window.innerWidth,window.innerHeight);L.appendChild(p.domElement);u=new THREE.Scene;M=new THREE.Clock;for(var f=transformSVGPath(h).getSpacedPoints(1E3,!0),e=[],g=0;g<f.length;g++)e.push(new THREE.Vector3(f[g].x,0,f[g].y));x=new THREE.ClosedSplineCurve3(e);k=x.getLength();N=1E3*a.trackLengthKM;E=N/k;for(var f=new THREE.PlaneGeometry(7,k,1,1E3),n=k/1E3,g=0;g<f.vertices.length;g+=2){var e=n*g/2,t=I(e),e=J(e).cross(new THREE.Vector3(0,
a.trackWidth,0)).clone().multiplyScalar(3),q=f.vertices[g+1];q.addVectors(t,e);q=f.vertices[g];q.addVectors(t,e.negate())}f.verticesNeedUpdate=!0;f.applyMatrix((new THREE.Matrix4).makeRotationY(a.rotate/180*Math.PI));f.computeBoundingSphere();f.computeBoundingBox();g={name:d.data.weibo.name,distance:d.data.weibo.distance,rankings:d.data.weibo.rankings,lap:d.data.weibo.lap,sideOffset:2.5,infoBoxSide:1,typeIndex:d.data.weibo.typeIndex,faster:0};g.speed0=d.data.weibo.speed;g.speed=1E3*(100>d.data.weibo.speed?
100:d.data.weibo.speed)/60/60/E;g.distance1=H(g.distance);g.lap0=g.lap;n={name:d.data.twitter.name,distance:d.data.twitter.distance,rankings:d.data.twitter.rankings,lap:d.data.twitter.lap,sideOffset:-2.5,infoBoxSide:-1,typeIndex:d.data.twitter.typeIndex,faster:0};n.speed0=d.data.twitter.speed;n.speed=1E3*(100>d.data.twitter.speed?100:d.data.twitter.speed)/60/60/E;n.distance1=H(n.distance);n.lap0=n.lap;e=f.boundingBox;C=e.max.x-e.min.x;D=e.max.z-e.min.z;f.applyMatrix((new THREE.Matrix4).makeRotationY(-a.rotate/
180*Math.PI));s=new THREE.Mesh(f,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));s.geometry.computeBoundingBox();s.geometry.computeBoundingSphere();B=f.boundingSphere.center.clone().negate();s.position.add(B);s.matrixAutoUpdate=!1;s.updateMatrix();u.add(s);f=window.innerWidth-200;t=window.innerHeight-200;e=Math.min(f/C,t/D);l=new THREE.OrthographicCamera(f/e/-2-100/e,f/e/2+100/e,t/e/2+100/e,t/e/-2-100/e,-500,2E3);l.position.set(0,1E3,0);l.up.set(1.42,1,-1).normalize();l.lookAt(new THREE.Vector3(0,
0,0));A=new THREE.Object3D;u.add(A);f=new THREE.PlaneGeometry(5,50,2,z);b=new THREE.Mesh(f,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[0].color}));b.frustumCulled=!1;b.position.set(0,1,0);b.matrixAutoUpdate=!1;b.updateMatrix();b.userData=g;y(b,!1);A.add(b);f=new THREE.PlaneGeometry(5,50,2,z);c=new THREE.Mesh(f,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[1].color}));
c.frustumCulled=!1;c.position.set(0,1.2,0);c.userData=n;y(c,!1);A.add(c);P({imageUrl:"image/mobile-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.02,finishCallback:function(a){w=a;u.add(w)},drawCallback:function(a,b,c,d){a.fillStyle=TYPES[d.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(d.name,b+12,c+8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+d.rankings,b+40,c+50);a.font=
"26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(d.rankings),b+72,c+50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(d.speed0)+"km/h",b+125,c+58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(d.lap),b+125,c+84)}});window.addEventListener("resize",r,!1);document.addEventListener("click",v,!1);m();F&&F()})()}})}})}})})()};
