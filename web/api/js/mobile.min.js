function trackCreate(F){function G(a){for(;1<a;)a--;for(;0>a;)a++;return a}function H(a){for(;a>k;)a-=k;for(;0>a;)a+=k;return a}function I(a){a/=k;a=G(a);return x.getPointAt(a).add(B)}function J(a){a/=k;a=G(a);return x.getTangentAt(a)}function y(a,d){void 0===d&&(d=!0);for(var b=0;b<a.geometry.vertices.length;b+=3){var h=a.userData.distance-O*b/3*(5+.2*a.userData.faster),e=I(h),m=J(h).cross(new THREE.Vector3(0,10,0));0==b&&(a.side=m.clone().multiplyScalar(a.userData.infoBoxSide));var k=m.clone().multiplyScalar(1.6*
a.userData.sideOffset),h=a.geometry.vertices[b+2],n=e.clone().add(k).add(m.clone().multiplyScalar(2));d?h.add(n.sub(h).multiplyScalar(v)):h.copy(n);h=a.geometry.vertices[b+1];n=e.clone().add(k);d?h.add(n.sub(h).multiplyScalar(v)):h.copy(n);h=a.geometry.vertices[b];e=e.clone().add(k).add(m.negate().multiplyScalar(2));d?h.add(e.sub(h).multiplyScalar(v)):h.copy(e)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;K()}function P(a){var d=new Image;d.onload=function(){var b=
d.width/4,h=d.height/2,e=document.createElement("canvas");e.width=2*b;e.height=2*h;var k=new THREE.Texture(e),p=e.getContext("2d"),n=new THREE.SpriteMaterial({opacity:a.opacity,map:k});n.depthTest=!1;var g=new THREE.Sprite(n);g.updateInfo=function(f){var c=Q,l=Math.atan2(f.side.x,f.side.z),c=c[Math.floor((l+Math.PI/4)/(Math.PI/2)+4)%4],l=b*c.x,n=h*c.y;p.clearRect(0,0,e.width,e.height);p.drawImage(d,b*c.wo,h*TYPES[f.userData.typeIndex].bgOffsetV,b,h,l,n,b,h);a.drawCallback&&a.drawCallback(p,l+13,n+
13,f.userData);k.needsUpdate=!0;f=f.localToWorld(f.geometry.vertices[3*(z-10)+1+f.userData.infoBoxSide].clone().setY(100));this.position.copy(f);this.scale.copy(g.scale0).multiplyScalar(m.position.distanceTo(f)*a.fixedScaleFactor)};g.scale.set(b/h*a.size,a.size,.1);g.scale0=g.scale.clone();g.visible=!1;a.finishCallback&&a.finishCallback(g)};d.src=a.imageUrl}function K(){w&&(w.visible=void 0!=q,q&&w.updateInfo(q))}var L,m,u,p,M,C,D,x,B=new THREE.Vector3(0,0,0),k,N,E,s,d,b,z=50,O=50/z,A,q,w,v=.1,Q=
[{wo:1,x:1,y:.5},{wo:0,x:.5,y:0},{wo:3,x:0,y:.5},{wo:2,x:.5,y:1}];(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var r=a.svgFile;"/"!==r[0]&&(r="data/"+r);$.ajax({url:r,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(r){var h=$("g path",r.documentElement).attr("d");dataApi.getRaceData(function(e){if(0!=e.status)console.error("Data status invalid: "+e.message,e);else{var r=function(){var a=window.innerWidth-200,b=window.innerHeight-
200,c=Math.min(a/C,b/D);m.left=a/c/-2-100/c;m.right=a/c/2+100/c;m.top=b/c/2+100/c;m.bottom=b/c/-2-100/c;m.updateProjectionMatrix();p.setSize(window.innerWidth,window.innerHeight)},v=function(a){q=q==d?b:d;K();p.render(u,m)},n=function(){requestAnimationFrame(n);var a=M.getDelta();d.userData.distance+=a*d.userData.speed;d.userData.distance1+=a*d.userData.speed;d.userData.lap=d.userData.lap0+Math.floor(d.userData.distance1/k);b.userData.distance+=a*b.userData.speed;b.userData.distance1+=a*b.userData.speed;
b.userData.lap=b.userData.lap0+Math.floor(b.userData.distance1/k);y(d,void 0);y(b,void 0);Math.max(d.userData.distance>b.userData.distance)?(followDistance=d.userData.distance,d.userData.rankings=1,b.userData.rankings=2):(followDistance=b.userData.distance,b.userData.rankings=1,d.userData.rankings=2);p.render(u,m)};(function(){L=document.getElementById("container");new THREE.Projector;p=new THREE.CanvasRenderer({alpha:!0});p.setClearColor(0,0);p.setSize(window.innerWidth,window.innerHeight);L.appendChild(p.domElement);
u=new THREE.Scene;M=new THREE.Clock;for(var g=transformSVGPath(h).getSpacedPoints(1E3,!0),f=[],c=0;c<g.length;c++)f.push(new THREE.Vector3(g[c].x,0,g[c].y));x=new THREE.ClosedSplineCurve3(f);k=x.getLength();N=1E3*a.trackLengthKM;E=N/k;for(var g=new THREE.PlaneGeometry(7,k,1,1E3),l=k/1E3,c=0;c<g.vertices.length;c+=2){var f=l*c/2,t=I(f),f=J(f).cross(new THREE.Vector3(0,a.trackWidth,0)).clone().multiplyScalar(3),q=g.vertices[c+1];q.addVectors(t,f);q=g.vertices[c];q.addVectors(t,f.negate())}g.verticesNeedUpdate=
!0;g.applyMatrix((new THREE.Matrix4).makeRotationY(a.rotate/180*Math.PI));g.computeBoundingSphere();g.computeBoundingBox();c={name:e.data.weibo.name,distance:e.data.weibo.distance,rankings:e.data.weibo.rankings,lap:e.data.weibo.lap,sideOffset:2.5,infoBoxSide:1,typeIndex:e.data.weibo.typeIndex};c.speed0=e.data.weibo.speed;c.speed=1E3*(100>e.data.weibo.speed?100:e.data.weibo.speed)/60/60/E;c.distance1=H(c.distance);c.lap0=c.lap;l={name:e.data.twitter.name,distance:e.data.twitter.distance,rankings:e.data.twitter.rankings,
lap:e.data.twitter.lap,sideOffset:-2.5,infoBoxSide:-1,typeIndex:e.data.twitter.typeIndex};l.speed0=e.data.twitter.speed;l.speed=1E3*(100>e.data.twitter.speed?100:e.data.twitter.speed)/60/60/E;l.distance1=H(l.distance);l.lap0=l.lap;Math.max(c.speed0>l.speed0)?(c.faster=1,l.faster=0):(c.faster=0,l.faster=1);f=g.boundingBox;C=f.max.x-f.min.x;D=f.max.z-f.min.z;g.applyMatrix((new THREE.Matrix4).makeRotationY(-a.rotate/180*Math.PI));s=new THREE.Mesh(g,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));
s.geometry.computeBoundingBox();s.geometry.computeBoundingSphere();B=g.boundingSphere.center.clone().negate();s.position.add(B);s.matrixAutoUpdate=!1;s.updateMatrix();u.add(s);g=window.innerWidth-200;t=window.innerHeight-200;f=Math.min(g/C,t/D);m=new THREE.OrthographicCamera(g/f/-2-100/f,g/f/2+100/f,t/f/2+100/f,t/f/-2-100/f,-500,2E3);m.position.set(0,1E3,0);m.up.set(1.42,1,-1).normalize();m.lookAt(new THREE.Vector3(0,0,0));A=new THREE.Object3D;u.add(A);g=new THREE.PlaneGeometry(5,50,2,z);d=new THREE.Mesh(g,
new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[0].color}));d.frustumCulled=!1;d.position.set(0,1,0);d.matrixAutoUpdate=!1;d.updateMatrix();d.userData=c;y(d,!1);A.add(d);g=new THREE.PlaneGeometry(5,50,2,z);b=new THREE.Mesh(g,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[1].color}));b.frustumCulled=!1;b.position.set(0,1.2,0);b.userData=l;y(b,!1);A.add(b);P({imageUrl:"image/mobile-infobox.png?"+
(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.02,finishCallback:function(a){w=a;u.add(w)},drawCallback:function(a,b,c,d){a.fillStyle=TYPES[d.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(d.name,b+12,c+8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+d.rankings,b+40,c+50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(d.rankings),b+72,c+50);a.font=
"15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(d.speed0)+"km/h",b+125,c+58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(d.lap),b+125,c+84)}});window.addEventListener("resize",r,!1);document.addEventListener("click",v,!1);n();F&&F()})()}})}})}})})()};
