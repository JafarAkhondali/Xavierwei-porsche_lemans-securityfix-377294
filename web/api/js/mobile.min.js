function trackCreate(F){function v(a){for(;1<a;)a--;for(;0>a;)a++;return a}function G(a){for(;a>g;)a-=g;for(;0>a;)a+=g;return a}function H(a){a/=g;a=v(a);return z.getPointAt(a).add(A)}function I(a){a/=g;a=v(a);return z.getTangentAt(a)}function B(a,c){void 0===c&&(c=!0);for(var d=0;d<a.geometry.vertices.length;d+=3){var f=a.userData.distance-O*d/3*(5+.2*a.userData.faster),b=H(f),h=I(f).cross(new THREE.Vector3(0,10,0)),g=h.clone().multiplyScalar(1.6*a.userData.sideOffset),f=a.geometry.vertices[d+2],
m=b.clone().add(g).add(h.clone().multiplyScalar(2));c?f.add(m.sub(f).multiplyScalar(w)):f.copy(m);f=a.geometry.vertices[d+1];m=b.clone().add(g);c?f.add(m.sub(f).multiplyScalar(w)):f.copy(m);f=a.geometry.vertices[d];b=b.clone().add(g).add(h.negate().multiplyScalar(2));c?f.add(b.sub(f).multiplyScalar(w)):f.copy(b)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;J()}function P(a){var c=new Image;c.onload=function(){var d=c.width,f=c.height,b=document.createElement("canvas");
b.width=d;b.height=f;var g=new THREE.Texture(b),n=b.getContext("2d"),b=new THREE.SpriteMaterial({opacity:a.opacity,map:g});b.depthTest=!1;var m=new THREE.Sprite(b);m.updateInfo=function(b){n.drawImage(c,0,f*TYPES[b.userData.typeIndex].bgOffsetV,d,f/2,0,0,d,f/2);a.drawCallback&&a.drawCallback(n,b.userData);g.needsUpdate=!0;b=b.localToWorld(b.geometry.vertices[1].clone().setY(100));this.position.copy(b);this.scale.copy(m.scale0).multiplyScalar(h.position.distanceTo(b)*a.fixedScaleFactor)};m.scale.set(d/
f*a.size,a.size,.1);m.scale0=m.scale.clone();m.visible=!1;a.finishCallback&&a.finishCallback(m)};c.src=a.imageUrl}function J(){x&&(x.visible=void 0!=p,p&&x.updateInfo(p))}var K,h,s,L,t,M,D,E,z,A=new THREE.Vector3(0,0,0),g,N,C,n,c,d,O=1,y,p,x,w=.1;(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var q=a.svgFile;"/"!==q[0]&&(q="data/"+q);$.ajax({url:q,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(q){var f=$("g path",q.documentElement).attr("d");
dataApi.getRaceData(function(b){if(0!=b.status)console.error("Data status invalid: "+b.message,b);else{var q=function(){var e=window.innerWidth-200,a=window.innerHeight-200,b=Math.min(e/D,a/E);h.left=e/b/-2-100/b;h.right=e/b/2+100/b;h.top=a/b/2+100/b;h.bottom=a/b/-2-100/b;h.updateProjectionMatrix();t.setSize(window.innerWidth,window.innerHeight)},w=function(a){if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=$(a.target).offset();a.offsetX=a.pageX-b.left;a.offsetY=a.pageY-b.top}a=
new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);L.unprojectVector(a,h);a=new THREE.Raycaster(h.position,a.sub(h.position).normalize());var b=a.intersectObjects(y.children),c;0<b.length&&(c=b[0].object);c!=p&&(p=c,J());b=a.intersectObject(n);0<b.length&&console.log("track");b=a.intersectObjects(s.children,!0);0<b.length&&console.log(b[0].object.name)},m=function(a){},v=function(){requestAnimationFrame(v);var a=M.getDelta();c.userData.distance+=a*c.userData.speed;
c.userData.distance1+=a*c.userData.speed;c.userData.lap=c.userData.lap0+Math.floor(c.userData.distance1/g);d.userData.distance+=a*d.userData.speed;d.userData.distance1+=a*d.userData.speed;d.userData.lap=d.userData.lap0+Math.floor(d.userData.distance1/g);B(c,void 0);B(d,void 0);Math.max(c.userData.distance>d.userData.distance)?(followDistance=c.userData.distance,c.userData.rankings=1,d.userData.rankings=2):(followDistance=d.userData.distance,d.userData.rankings=1,c.userData.rankings=2);Math.max(c.userData.speed>
d.userData.speed)?(c.userData.faster=1,d.userData.faster=0):(c.userData.faster=0,d.userData.faster=1);t.render(s,h)};(function(){K=document.getElementById("container");L=new THREE.Projector;t=new THREE.CanvasRenderer({alpha:!0});t.setClearColor(0,0);t.setSize(window.innerWidth,window.innerHeight);K.appendChild(t.domElement);s=new THREE.Scene;M=new THREE.Clock;for(var e=transformSVGPath(f).getSpacedPoints(1E3,!0),k=[],l=0;l<e.length;l++)k.push(new THREE.Vector3(e[l].x,0,e[l].y));z=new THREE.ClosedSplineCurve3(k);
g=z.getLength();N=1E3*a.trackLengthKM;C=N/g;for(var e=new THREE.PlaneGeometry(7,g,1,1E3),r=g/1E3,l=0;l<e.vertices.length;l+=2){var k=r*l/2,u=H(k),k=I(k).cross(new THREE.Vector3(0,a.trackWidth,0)).clone().multiplyScalar(3),p=e.vertices[l+1];p.addVectors(u,k);p=e.vertices[l];p.addVectors(u,k.negate())}e.verticesNeedUpdate=!0;e.computeBoundingSphere();e.computeBoundingBox();A=e.boundingSphere.center.clone().negate();console.log(A);l={name:b.data.weibo.name,distance:b.data.weibo.distance,rankings:b.data.weibo.rankings,
lap:b.data.weibo.lap,speed:1E3*b.data.weibo.speed/60/60/C,sideOffset:2.5,typeIndex:b.data.weibo.typeIndex,faster:0};l.distance1=G(l.distance);l.lap0=l.lap;r={name:b.data.twitter.name,distance:b.data.twitter.distance,rankings:b.data.twitter.rankings,lap:b.data.twitter.lap,speed:1E3*b.data.twitter.speed/60/60/C,sideOffset:-2.5,typeIndex:b.data.twitter.typeIndex,faster:0};r.distance1=G(r.distance);r.lap0=r.lap;n=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));n.geometry.computeBoundingBox();
n.geometry.computeBoundingSphere();n.position.add(A);n.matrixAutoUpdate=!1;n.updateMatrix();s.add(n);e=n.geometry.boundingBox;D=e.max.x-e.min.x;E=e.max.z-e.min.z;e=window.innerWidth-200;u=window.innerHeight-200;k=Math.min(e/D,u/E);h=new THREE.OrthographicCamera(e/k/-2-100/k,e/k/2+100/k,u/k/2+100/k,u/k/-2-100/k,-500,2E3);h.position.set(0,1E3,0);h.up.set(0,0,-1);h.lookAt(new THREE.Vector3(0,0,0));y=new THREE.Object3D;s.add(y);e=new THREE.PlaneGeometry(5,50,2,50);c=new THREE.Mesh(e,new THREE.MeshBasicMaterial({transparent:!0,
opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red-mobile.png?"+(new Date).getTime())}));c.frustumCulled=!1;c.position.set(0,1,0);c.matrixAutoUpdate=!1;c.updateMatrix();c.userData=l;B(c,!1);y.add(c);e=new THREE.PlaneGeometry(5,50,2,50);d=new THREE.Mesh(e,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue-mobile.png?"+(new Date).getTime())}));d.frustumCulled=!1;d.position.set(0,
1.2,0);d.userData=r;B(d,!1);y.add(d);P({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){x=a;s.add(x)},drawCallback:function(a,b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,12,8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";
a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(b.speed*C*3600/1E3)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(b.lap),125,84)}});window.addEventListener("resize",q,!1);document.addEventListener("mousemove",w,!1);document.addEventListener("click",m,!1);v();F&&F()})()}})}})}})})()};
