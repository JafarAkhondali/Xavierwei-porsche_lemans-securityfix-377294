function trackCreate(F){function G(a){for(;1<a;)a--;for(;0>a;)a++;return a}function H(a){for(;a>k;)a-=k;for(;0>a;)a+=k;return a}function I(a){a/=k;a=G(a);return x.getPointAt(a).add(C)}function J(a){a/=k;a=G(a);return x.getTangentAt(a)}function y(a,b){void 0===b&&(b=!0);for(var c=0;c<a.geometry.vertices.length;c+=3){var g=a.userData.distance-O*c/3*(5+.2*a.userData.faster),f=I(g),l=J(g).cross(new THREE.Vector3(0,10,0));0==c&&(a.side=l.clone().multiplyScalar(a.userData.infoBoxSide));var k=l.clone().multiplyScalar(1.6*
a.userData.sideOffset),g=a.geometry.vertices[c+2],m=f.clone().add(k).add(l.clone().multiplyScalar(2));b?g.add(m.sub(g).multiplyScalar(v)):g.copy(m);g=a.geometry.vertices[c+1];m=f.clone().add(k);b?g.add(m.sub(g).multiplyScalar(v)):g.copy(m);g=a.geometry.vertices[c];f=f.clone().add(k).add(l.negate().multiplyScalar(2));b?g.add(f.sub(g).multiplyScalar(v)):g.copy(f)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;K()}function P(a){var b=new Image;b.onload=function(){var c=
b.width/4,g=b.height/2,f=document.createElement("canvas");f.width=2*c;f.height=2*g;var k=new THREE.Texture(f),p=f.getContext("2d"),m=new THREE.SpriteMaterial({opacity:a.opacity,map:k});m.depthTest=!1;var e=new THREE.Sprite(m);e.updateInfo=function(d){var h=Q,n=Math.atan2(d.side.x,d.side.z),h=h[Math.floor((n+Math.PI/4)/(Math.PI/2)+4)%4],n=c*h.x,m=g*h.y;p.clearRect(0,0,f.width,f.height);p.drawImage(b,c*h.wo,g*TYPES[d.userData.typeIndex].bgOffsetV,c,g,n,m,c,g);a.drawCallback&&a.drawCallback(p,n+13,m+
13,d.userData);k.needsUpdate=!0;d=d.localToWorld(d.geometry.vertices[3*(z-10)+1+d.userData.infoBoxSide].clone().setY(100));this.position.copy(d);this.scale.copy(e.scale0).multiplyScalar(l.position.distanceTo(d)*a.fixedScaleFactor)};e.scale.set(c/g*a.size,a.size,.1);e.scale0=e.scale.clone();e.visible=!1;a.finishCallback&&a.finishCallback(e)};b.src=a.imageUrl}function K(){w&&(w.visible=void 0!=q,q&&w.updateInfo(q))}var L,l,u,p,M,D,E,x,C=new THREE.Vector3(0,0,0),k,N,A,s,b,c,z=50,O=50/z,B,q,w,v=.1,Q=
[{wo:1,x:1,y:.5},{wo:0,x:.5,y:0},{wo:3,x:0,y:.5},{wo:2,x:.5,y:1}];(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var r=a.svgFile;"/"!==r[0]&&(r="data/"+r);$.ajax({url:r,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(r){var g=$("g path",r.documentElement).attr("d");dataApi.getRaceData(function(f){if(0!=f.status)console.error("Data status invalid: "+f.message,f);else{var r=function(){var a=window.innerWidth-200,c=window.innerHeight-
200,b=Math.min(a/D,c/E);l.left=a/b/-2-100/b;l.right=a/b/2+100/b;l.top=c/b/2+100/b;l.bottom=c/b/-2-100/b;l.updateProjectionMatrix();p.setSize(window.innerWidth,window.innerHeight)},v=function(a){q=q==b?c:b;K();p.render(u,l)},m=function(){requestAnimationFrame(m);var a=M.getDelta();b.userData.distance+=a*b.userData.speed;b.userData.distance1+=a*b.userData.speed;b.userData.lap=b.userData.lap0+Math.floor(b.userData.distance1/k);c.userData.distance+=a*c.userData.speed;c.userData.distance1+=a*c.userData.speed;
c.userData.lap=c.userData.lap0+Math.floor(c.userData.distance1/k);y(b,void 0);y(c,void 0);Math.max(b.userData.distance>c.userData.distance)?(followDistance=b.userData.distance,b.userData.rankings=1,c.userData.rankings=2):(followDistance=c.userData.distance,c.userData.rankings=1,b.userData.rankings=2);Math.max(b.userData.speed>c.userData.speed)?(b.userData.faster=1,c.userData.faster=0):(b.userData.faster=0,c.userData.faster=1);p.render(u,l)};(function(){L=document.getElementById("container");new THREE.Projector;
p=new THREE.CanvasRenderer({alpha:!0});p.setClearColor(0,0);p.setSize(window.innerWidth,window.innerHeight);L.appendChild(p.domElement);u=new THREE.Scene;M=new THREE.Clock;for(var e=transformSVGPath(g).getSpacedPoints(1E3,!0),d=[],h=0;h<e.length;h++)d.push(new THREE.Vector3(e[h].x,0,e[h].y));x=new THREE.ClosedSplineCurve3(d);k=x.getLength();N=1E3*a.trackLengthKM;A=N/k;for(var e=new THREE.PlaneGeometry(7,k,1,1E3),n=k/1E3,h=0;h<e.vertices.length;h+=2){var d=n*h/2,t=I(d),d=J(d).cross(new THREE.Vector3(0,
a.trackWidth,0)).clone().multiplyScalar(3),q=e.vertices[h+1];q.addVectors(t,d);q=e.vertices[h];q.addVectors(t,d.negate())}e.verticesNeedUpdate=!0;e.applyMatrix((new THREE.Matrix4).makeRotationY(a.rotate/180*Math.PI));e.computeBoundingSphere();e.computeBoundingBox();h={name:f.data.weibo.name,distance:f.data.weibo.distance,rankings:f.data.weibo.rankings,lap:f.data.weibo.lap,speed:1E3*f.data.weibo.speed/60/60/A,sideOffset:2.5,infoBoxSide:1,typeIndex:f.data.weibo.typeIndex,faster:0};h.distance1=H(h.distance);
h.lap0=h.lap;n={name:f.data.twitter.name,distance:f.data.twitter.distance,rankings:f.data.twitter.rankings,lap:f.data.twitter.lap,speed:1E3*f.data.twitter.speed/60/60/A,sideOffset:-2.5,infoBoxSide:-1,typeIndex:f.data.twitter.typeIndex,faster:0};n.distance1=H(n.distance);n.lap0=n.lap;d=e.boundingBox;D=d.max.x-d.min.x;E=d.max.z-d.min.z;e.applyMatrix((new THREE.Matrix4).makeRotationY(-a.rotate/180*Math.PI));s=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));s.geometry.computeBoundingBox();
s.geometry.computeBoundingSphere();C=e.boundingSphere.center.clone().negate();s.position.add(C);s.matrixAutoUpdate=!1;s.updateMatrix();u.add(s);e=window.innerWidth-200;t=window.innerHeight-200;d=Math.min(e/D,t/E);l=new THREE.OrthographicCamera(e/d/-2-100/d,e/d/2+100/d,t/d/2+100/d,t/d/-2-100/d,-500,2E3);l.position.set(0,1E3,0);l.up.set(1.42,1,-1).normalize();l.lookAt(new THREE.Vector3(0,0,0));B=new THREE.Object3D;u.add(B);e=new THREE.PlaneGeometry(5,50,2,z);b=new THREE.Mesh(e,new THREE.MeshBasicMaterial({transparent:!0,
opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[0].color}));b.frustumCulled=!1;b.position.set(0,1,0);b.matrixAutoUpdate=!1;b.updateMatrix();b.userData=h;y(b,!1);B.add(b);e=new THREE.PlaneGeometry(5,50,2,z);c=new THREE.Mesh(e,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[1].color}));c.frustumCulled=!1;c.position.set(0,1.2,0);c.userData=n;y(c,!1);B.add(c);P({imageUrl:"image/mobile-infobox.png?"+(new Date).getTime(),
opacity:.86,size:15,fixedScaleFactor:.02,finishCallback:function(a){w=a;u.add(w)},drawCallback:function(a,b,c,d){a.fillStyle=TYPES[d.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(d.name,b+12,c+8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+d.rankings,b+40,c+50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(d.rankings),b+72,c+50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";
a.fillText(""+Math.round(d.speed*A*3600/1E3)+"km/h",b+125,c+58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(d.lap),b+125,c+84)}});window.addEventListener("resize",r,!1);document.addEventListener("click",v,!1);m();F&&F()})()}})}})}})})()};
