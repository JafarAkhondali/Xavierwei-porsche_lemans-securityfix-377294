function trackCreate(F){function G(a){for(;1<a;)a--;for(;0>a;)a++;return a}function H(a){for(;a>k;)a-=k;for(;0>a;)a+=k;return a}function I(a){a/=k;a=G(a);return y.getPointAt(a).add(C)}function J(a){a/=k;a=G(a);return y.getTangentAt(a)}function z(a,b){void 0===b&&(b=!0);for(var c=0;c<a.geometry.vertices.length;c+=3){var g=a.userData.distance-P*c/3*(5+.2*a.userData.faster),f=I(g),l=J(g).cross(new THREE.Vector3(0,10,0));0==c&&(a.side=l.clone().multiplyScalar(a.userData.infoBoxSide));var k=l.clone().multiplyScalar(1.6*
a.userData.sideOffset),g=a.geometry.vertices[c+2],m=f.clone().add(k).add(l.clone().multiplyScalar(2));b?g.add(m.sub(g).multiplyScalar(u)):g.copy(m);g=a.geometry.vertices[c+1];m=f.clone().add(k);b?g.add(m.sub(g).multiplyScalar(u)):g.copy(m);g=a.geometry.vertices[c];f=f.clone().add(k).add(l.negate().multiplyScalar(2));b?g.add(f.sub(g).multiplyScalar(u)):g.copy(f)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;K()}function Q(a){var c=new Image;c.onload=function(){var b=
c.width/4,g=c.height/2,f=document.createElement("canvas");f.width=2*b;f.height=2*g;var k=new THREE.Texture(f),p=f.getContext("2d"),m=new THREE.SpriteMaterial({opacity:a.opacity,map:k});m.depthTest=!1;var d=new THREE.Sprite(m);d.updateInfo=function(e){var h=R,n=Math.atan2(e.side.x,e.side.z),h=h[Math.floor((n+Math.PI/4)/(Math.PI/2)+4)%4],n=b*h.x,m=g*h.y;p.clearRect(0,0,f.width,f.height);p.drawImage(c,b*h.wo,g*TYPES[e.userData.typeIndex].bgOffsetV,b,g,n,m,b,g);a.drawCallback&&a.drawCallback(p,n+13,m+
13,e.userData);k.needsUpdate=!0;e=e.localToWorld(e.geometry.vertices[3*(A-10)+1+e.userData.infoBoxSide].clone().setY(100));this.position.copy(e);this.scale.copy(d.scale0).multiplyScalar(l.position.distanceTo(e)*a.fixedScaleFactor)};d.scale.set(b/g*a.size,a.size,.1);d.scale0=d.scale.clone();d.visible=!1;a.finishCallback&&a.finishCallback(d)};c.src=a.imageUrl}function K(){v&&(v.visible=void 0!=q,q&&v.updateInfo(q))}var L,l,w,M,t,N,D,E,y,C=new THREE.Vector3(0,0,0),k,O,B,p,b,c,A=50,P=50/A,x,q,v,u=.1,
R=[{wo:1,x:1,y:.5},{wo:0,x:.5,y:0},{wo:3,x:0,y:.5},{wo:2,x:.5,y:1}];(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var r=a.svgFile;"/"!==r[0]&&(r="data/"+r);$.ajax({url:r,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(r){var g=$("g path",r.documentElement).attr("d");dataApi.getRaceData(function(f){if(0!=f.status)console.error("Data status invalid: "+f.message,f);else{var r=function(){var d=window.innerWidth-200,a=window.innerHeight-
200,b=Math.min(d/D,a/E);l.left=d/b/-2-100/b;l.right=d/b/2+100/b;l.top=a/b/2+100/b;l.bottom=a/b/-2-100/b;l.updateProjectionMatrix();t.setSize(window.innerWidth,window.innerHeight)},u=function(a){if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=$(a.target).offset();a.offsetX=a.pageX-b.left;a.offsetY=a.pageY-b.top}a=new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);a=M.pickingRay(a,l).intersectObjects(x.children);var c;0<a.length&&(c=a[0].object);
c!=q&&(q=c,K())},m=function(){requestAnimationFrame(m);var a=N.getDelta();b.userData.distance+=a*b.userData.speed;b.userData.distance1+=a*b.userData.speed;b.userData.lap=b.userData.lap0+Math.floor(b.userData.distance1/k);c.userData.distance+=a*c.userData.speed;c.userData.distance1+=a*c.userData.speed;c.userData.lap=c.userData.lap0+Math.floor(c.userData.distance1/k);z(b,void 0);z(c,void 0);Math.max(b.userData.distance>c.userData.distance)?(followDistance=b.userData.distance,b.userData.rankings=1,c.userData.rankings=
2):(followDistance=c.userData.distance,c.userData.rankings=1,b.userData.rankings=2);Math.max(b.userData.speed>c.userData.speed)?(b.userData.faster=1,c.userData.faster=0):(b.userData.faster=0,c.userData.faster=1);t.render(w,l)};(function(){L=document.getElementById("container");M=new THREE.Projector;t=new THREE.CanvasRenderer({alpha:!0});t.setClearColor(0,0);t.setSize(window.innerWidth,window.innerHeight);L.appendChild(t.domElement);w=new THREE.Scene;N=new THREE.Clock;for(var d=transformSVGPath(g).getSpacedPoints(1E3,
!0),e=[],h=0;h<d.length;h++)e.push(new THREE.Vector3(d[h].x,0,d[h].y));y=new THREE.ClosedSplineCurve3(e);k=y.getLength();O=1E3*a.trackLengthKM;B=O/k;for(var d=new THREE.PlaneGeometry(7,k,1,1E3),n=k/1E3,h=0;h<d.vertices.length;h+=2){var e=n*h/2,s=I(e),e=J(e).cross(new THREE.Vector3(0,a.trackWidth,0)).clone().multiplyScalar(3),q=d.vertices[h+1];q.addVectors(s,e);q=d.vertices[h];q.addVectors(s,e.negate())}d.verticesNeedUpdate=!0;d.applyMatrix((new THREE.Matrix4).makeRotationY(a.rotate/180*Math.PI));
d.computeBoundingSphere();d.computeBoundingBox();h={name:f.data.weibo.name,distance:f.data.weibo.distance,rankings:f.data.weibo.rankings,lap:f.data.weibo.lap,speed:1E3*f.data.weibo.speed/60/60/B,sideOffset:2.5,infoBoxSide:1,typeIndex:f.data.weibo.typeIndex,faster:0};h.distance1=H(h.distance);h.lap0=h.lap;n={name:f.data.twitter.name,distance:f.data.twitter.distance,rankings:f.data.twitter.rankings,lap:f.data.twitter.lap,speed:1E3*f.data.twitter.speed/60/60/B,sideOffset:-2.5,infoBoxSide:-1,typeIndex:f.data.twitter.typeIndex,
faster:0};n.distance1=H(n.distance);n.lap0=n.lap;e=d.boundingBox;D=e.max.x-e.min.x;E=e.max.z-e.min.z;d.applyMatrix((new THREE.Matrix4).makeRotationY(-a.rotate/180*Math.PI));p=new THREE.Mesh(d,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));p.geometry.computeBoundingBox();p.geometry.computeBoundingSphere();C=d.boundingSphere.center.clone().negate();p.position.add(C);p.matrixAutoUpdate=!1;p.updateMatrix();w.add(p);d=window.innerWidth-200;s=window.innerHeight-200;e=Math.min(d/D,s/E);
l=new THREE.OrthographicCamera(d/e/-2-100/e,d/e/2+100/e,s/e/2+100/e,s/e/-2-100/e,-500,2E3);l.position.set(0,1E3,0);l.up.set(1.42,1,-1).normalize();l.lookAt(new THREE.Vector3(0,0,0));x=new THREE.Object3D;w.add(x);d=new THREE.PlaneGeometry(5,50,2,A);b=new THREE.Mesh(d,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red-mobile.png?"+(new Date).getTime())}));b.frustumCulled=!1;b.position.set(0,1,0);b.matrixAutoUpdate=
!1;b.updateMatrix();b.userData=h;z(b,!1);x.add(b);d=new THREE.PlaneGeometry(5,50,2,A);c=new THREE.Mesh(d,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue-mobile.png?"+(new Date).getTime())}));c.frustumCulled=!1;c.position.set(0,1.2,0);c.userData=n;z(c,!1);x.add(c);Q({imageUrl:"image/mobile-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.02,finishCallback:function(a){v=a;w.add(v)},drawCallback:function(a,
b,c,d){a.fillStyle=TYPES[d.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(d.name,b+12,c+8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+d.rankings,b+40,c+50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(d.rankings),b+72,c+50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(d.speed*B*3600/1E3)+"km/h",b+125,c+58);a.font=
"14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(d.lap),b+125,c+84)}});window.addEventListener("resize",r,!1);document.addEventListener("click",u,!1);m();F&&F()})()}})}})}})})()};
