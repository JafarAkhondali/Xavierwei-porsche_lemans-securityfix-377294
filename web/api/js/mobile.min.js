function trackCreate(F){function G(a){for(;1<a;)a--;for(;0>a;)a++;return a}function H(a){for(;a>k;)a-=k;for(;0>a;)a+=k;return a}function I(a){a/=k;a=G(a);return x.getPointAt(a).add(B)}function J(a){a/=k;a=G(a);return x.getTangentAt(a)}function y(a,d){void 0===d&&(d=!0);for(var b=0;b<a.geometry.vertices.length;b+=3){var h=a.userData.distance-O*b/3*(5+.2*a.userData.faster),e=I(h),m=J(h).cross(new THREE.Vector3(0,10,0));0==b&&(a.side=m.clone().multiplyScalar(a.userData.infoBoxSide));var k=m.clone().multiplyScalar(1.6*
a.userData.sideOffset),h=a.geometry.vertices[b+2],n=e.clone().add(k).add(m.clone().multiplyScalar(2));d?h.add(n.sub(h).multiplyScalar(v)):h.copy(n);h=a.geometry.vertices[b+1];n=e.clone().add(k);d?h.add(n.sub(h).multiplyScalar(v)):h.copy(n);h=a.geometry.vertices[b];e=e.clone().add(k).add(m.negate().multiplyScalar(2));d?h.add(e.sub(h).multiplyScalar(v)):h.copy(e)}a.geometry.verticesNeedUpdate=!0;a.geometry.boundingSphere=null;a.geometry.boundingBox=null;K()}function P(a){var d=new Image;d.onload=function(){var b=
d.width/4,h=d.height/2,e=document.createElement("canvas");e.width=2*b;e.height=2*h;var k=new THREE.Texture(e),p=e.getContext("2d"),n=new THREE.SpriteMaterial({opacity:a.opacity,map:k});n.depthTest=!1;var f=new THREE.Sprite(n);f.updateInfo=function(c){var g=Q,l=Math.atan2(c.side.x,c.side.z),g=g[Math.floor((l+Math.PI/4)/(Math.PI/2)+4)%4],l=b*g.x,n=h*g.y;p.clearRect(0,0,e.width,e.height);p.drawImage(d,b*g.wo,h*TYPES[c.userData.typeIndex].bgOffsetV,b,h,l,n,b,h);a.drawCallback&&a.drawCallback(p,l+13,n+
13,c.userData);k.needsUpdate=!0;c=c.localToWorld(c.geometry.vertices[3*(z-10)+1+c.userData.infoBoxSide].clone().setY(100));this.position.copy(c);this.scale.copy(f.scale0).multiplyScalar(m.position.distanceTo(c)*a.fixedScaleFactor)};f.scale.set(b/h*a.size,a.size,.1);f.scale0=f.scale.clone();f.visible=!1;a.finishCallback&&a.finishCallback(f)};d.src=a.imageUrl}function K(){w&&(w.visible=void 0!=q,q&&w.updateInfo(q))}var L,m,u,p,M,C,D,x,B=new THREE.Vector3(0,0,0),k,N,E,s,d,b,z=50,O=50/z,A,q,w,v=.1,Q=
[{wo:1,x:1,y:.5},{wo:0,x:.5,y:0},{wo:3,x:0,y:.5},{wo:2,x:.5,y:1}];(function(){$.ajax({url:"data/mobile.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var r=a.svgFile;"/"!==r[0]&&(r="data/"+r);$.ajax({url:r,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(r){var h=$("g path",r.documentElement).attr("d");dataApi.getRaceData(function(e){if(0!=e.status)console.error("Data status invalid: "+e.message,e);else{var r=function(){var a=window.innerWidth-200,c=window.innerHeight-
200,b=Math.min(a/C,c/D);m.left=a/b/-2-100/b;m.right=a/b/2+100/b;m.top=c/b/2+100/b;m.bottom=c/b/-2-100/b;m.updateProjectionMatrix();p.setSize(window.innerWidth,window.innerHeight)},v=function(a){q=q==d?b:d;K();p.render(u,m)},n=function(){requestAnimationFrame(n);var a=M.getDelta();d.userData.distance+=a*d.userData.speed;d.userData.distance1+=a*d.userData.speed;d.userData.lap=d.userData.lap0+Math.floor(d.userData.distance1/k);b.userData.distance+=a*b.userData.speed;b.userData.distance1+=a*b.userData.speed;
b.userData.lap=b.userData.lap0+Math.floor(b.userData.distance1/k);y(d,void 0);y(b,void 0);Math.max(d.userData.distance>b.userData.distance)?(followDistance=d.userData.distance,d.userData.rankings=1,b.userData.rankings=2):(followDistance=b.userData.distance,b.userData.rankings=1,d.userData.rankings=2);p.render(u,m)};(function(){L=document.getElementById("container");new THREE.Projector;p=new THREE.CanvasRenderer({alpha:!0});p.setClearColor(0,0);p.setSize(window.innerWidth,window.innerHeight);L.appendChild(p.domElement);
u=new THREE.Scene;M=new THREE.Clock;for(var f=transformSVGPath(h).getSpacedPoints(1E3,!0),c=[],g=0;g<f.length;g++)c.push(new THREE.Vector3(f[g].x,0,f[g].y));x=new THREE.ClosedSplineCurve3(c);k=x.getLength();N=1E3*a.trackLengthKM;E=N/k;for(var f=new THREE.PlaneGeometry(7,k,1,1E3),l=k/1E3,g=0;g<f.vertices.length;g+=2){var c=l*g/2,t=I(c),c=J(c).cross(new THREE.Vector3(0,a.trackWidth,0)).clone().multiplyScalar(3),q=f.vertices[g+1];q.addVectors(t,c);q=f.vertices[g];q.addVectors(t,c.negate())}f.verticesNeedUpdate=
!0;f.applyMatrix((new THREE.Matrix4).makeRotationY(a.rotate/180*Math.PI));f.computeBoundingSphere();f.computeBoundingBox();g={name:e.data.weibo.name,distance:e.data.weibo.distance,rankings:e.data.weibo.rankings,lap:e.data.weibo.lap,sideOffset:2.5,infoBoxSide:1,typeIndex:e.data.weibo.typeIndex};g.speed0=e.data.weibo.speed;g.distance1=H(g.distance);g.lap0=g.lap;l={name:e.data.twitter.name,distance:e.data.twitter.distance,rankings:e.data.twitter.rankings,lap:e.data.twitter.lap,sideOffset:-2.5,infoBoxSide:-1,
typeIndex:e.data.twitter.typeIndex};l.speed0=e.data.twitter.speed;l.distance1=H(l.distance);l.lap0=l.lap;c=1;150>e.data.weibo.speed&&150>e.data.twitter.speed&&(c=150/Math.max(e.data.weibo.speed,e.data.twitter.speed));g.speed=e.data.weibo.speed*c*1E3/60/60/E;l.speed=e.data.twitter.speed*c*1E3/60/60/E;Math.max(g.speed0>l.speed0)?(g.faster=1,l.faster=0):(g.faster=0,l.faster=1);c=f.boundingBox;C=c.max.x-c.min.x;D=c.max.z-c.min.z;f.applyMatrix((new THREE.Matrix4).makeRotationY(-a.rotate/180*Math.PI));
s=new THREE.Mesh(f,new THREE.MeshBasicMaterial({side:THREE.BackSide,overdraw:.5}));s.geometry.computeBoundingBox();s.geometry.computeBoundingSphere();B=f.boundingSphere.center.clone().negate();s.position.add(B);s.matrixAutoUpdate=!1;s.updateMatrix();u.add(s);f=window.innerWidth-200;t=window.innerHeight-200;c=Math.min(f/C,t/D);m=new THREE.OrthographicCamera(f/c/-2-100/c,f/c/2+100/c,t/c/2+100/c,t/c/-2-100/c,-500,2E3);m.position.set(0,1E3,0);m.up.set(1.42,1,-1).normalize();m.lookAt(new THREE.Vector3(0,
0,0));A=new THREE.Object3D;u.add(A);f=new THREE.PlaneGeometry(5,50,2,z);d=new THREE.Mesh(f,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[0].color}));d.frustumCulled=!1;d.position.set(0,1,0);d.matrixAutoUpdate=!1;d.updateMatrix();d.userData=g;y(d,!1);A.add(d);f=new THREE.PlaneGeometry(5,50,2,z);b=new THREE.Mesh(f,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,overdraw:.5,color:TYPES[1].color}));
b.frustumCulled=!1;b.position.set(0,1.2,0);b.userData=l;y(b,!1);A.add(b);P({imageUrl:"image/mobile-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.02,finishCallback:function(a){w=a;u.add(w)},drawCallback:function(a,b,c,d){a.fillStyle=TYPES[d.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(d.name,b+12,c+8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+d.rankings,b+40,c+50);a.font=
"26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(d.rankings),b+72,c+50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(d.speed0)+"km/h",b+125,c+58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText("Lap:"+Math.round(d.lap),b+125,c+84)}});window.addEventListener("resize",r,!1);document.addEventListener("click",v,!1);n();F&&F()})()}})}})}})})()};
