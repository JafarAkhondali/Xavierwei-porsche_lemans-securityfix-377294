function trackCreate(T){function C(a){for(;1<a;)a--;for(;0>a;)a++;return a}function U(a){for(;a>f;)a-=f;for(;0>a;)a+=f;return a}function q(a){a=C(a);return L.getPointAt(a).add(D)}function O(a){a/=f;a=C(a);return L.getTangentAt(a)}function ca(a,l,d){return a<=l?l:a>=d?d:a}function da(a){for(var l=1,d=0;d<x.length;d++)a>=x[d]&&(l=(0==d%2?1:-1)*Math.cos(ca((a-x[d])*ea,0,Math.PI)));return l}function M(a,l,d){a.position.copy(q(a.userData.distance/f));a=d;void 0===a&&(a=!0);for(d=0;d<l.geometry.vertices.length;d+=
3){var b=l.userData.distance-fa*d/3*(1+.2*l.userData.faster),e=q(b/f),g=O(b).cross(new THREE.Vector3(0,1,0)),y=g.clone().multiplyScalar(l.userData.sideOffset*da(50*C(b/f))),b=l.geometry.vertices[d+2],m=e.clone().add(y).add(g.clone().multiplyScalar(2));a?b.add(m.sub(b).multiplyScalar(E)):b.copy(m);b=l.geometry.vertices[d+1];m=e.clone().add(y);a?b.add(m.sub(b).multiplyScalar(E)):b.copy(m);b=l.geometry.vertices[d];e=e.clone().add(y).add(g.negate().multiplyScalar(2));a?b.add(e.sub(b).multiplyScalar(E)):
b.copy(e)}l.geometry.verticesNeedUpdate=!0;l.geometry.boundingSphere=null;l.geometry.boundingBox=null;V()}function ga(a){var e=new Image;e.onload=function(){var g=e.width,b=e.height,f=document.createElement("canvas");f.width=g;f.height=b;var q=new THREE.Texture(f),y=f.getContext("2d"),f=new THREE.SpriteMaterial({opacity:a.opacity,map:q});f.depthTest=!1;var r=new THREE.Sprite(f);r.updateInfo=function(f){y.drawImage(e,0,b*TYPES[f.userData.typeIndex].bgOffsetV,g,b/2,0,0,g,b/2);a.drawCallback&&a.drawCallback(y,
f.userData);q.needsUpdate=!0;f=f.localToWorld(f.geometry.vertices[1].clone());this.position.copy(f);this.scale.copy(r.scale0).multiplyScalar(m.position.distanceTo(f)*a.fixedScaleFactor)};r.scale.set(g/b*a.size,a.size,.1);r.scale0=r.scale.clone();r.visible=!1;a.finishCallback&&a.finishCallback(r)};e.src=a.imageUrl}function V(){F&&(F.visible=void 0!=G,G&&F.updateInfo(G))}var W,m,t,X,z,P,H,I,J,Q=new THREE.Vector3(0,0,0),ha=new THREE.Vector3(0,0,0),Y=0,Z,R=window.innerWidth/2,L,D=new THREE.Vector3(0,
0,0),f,aa,N,A,B,u,e,g,fa=1,K,G,F,S,x,E=.1,ea=10;(function(){$.ajax({url:"data/track.json",type:"GET",async:!0,cache:!1,dataType:"json",success:function(a){var l=a.cameraFollow,d=0;x=a.sideShiftPercents;var b=a.svgFile;"/"!==b[0]&&(b="data/"+b);$.ajax({url:b,type:"GET",async:!0,cache:!1,dataType:"xml",success:function(b){var x=$("g path",b.documentElement).attr("d");dataApi.getRaceData(function(b){if(0!=b.status)console.error("Data status invalid: "+b.message,b);else{var r=function(){R=window.innerWidth/
2;m.aspect=window.innerWidth/window.innerHeight;m.updateProjectionMatrix();z.setSize(window.innerWidth,window.innerHeight)},C=function(a){Y=a.clientX-R;if("undefined"===typeof a.offsetX||"undefined"===typeof a.offsetY){var b=$(a.target).offset();a.offsetX=a.pageX-b.left;a.offsetY=a.pageY-b.top}a=new THREE.Vector3(a.offsetX/window.innerWidth*2-1,2*-(a.offsetY/window.innerHeight)+1,.5);X.unprojectVector(a,m);a=(new THREE.Raycaster(m.position,a.sub(m.position).normalize())).intersectObjects(K.children);
var e;0<a.length&&(e=a[0].object);e!=G&&(G=e,V())},E=function(a){d=(d+1)%l.locations.length},ba=function(){requestAnimationFrame(ba);var a=P.getDelta();e.userData.distance+=a*e.userData.speed;e.userData.distance1+=a*e.userData.speed;e.userData.lap=e.userData.lap0+Math.floor(e.userData.distance1/f);g.userData.distance+=a*g.userData.speed;g.userData.distance1+=a*g.userData.speed;g.userData.lap=g.userData.lap0+Math.floor(g.userData.distance1/f);M(A,e);M(B,g);Math.max(e.userData.distance>g.userData.distance)?
(a=e.userData.distance,e.userData.rankings=1,g.userData.rankings=2):(a=g.userData.distance,g.userData.rankings=1,e.userData.rankings=2);Math.max(e.userData.speed>g.userData.speed)?(e.userData.faster=1,g.userData.faster=0):(e.userData.faster=0,g.userData.faster=1);var b=q(a/f).add(ha);Q.add(b.sub(Q).multiplyScalar(l.lookAtFactor));b=l.locations[d];a=q((a+b.distance)/f);b.height&&(a.y+=b.height);m.position.add(a.sub(m.position).multiplyScalar(l.followFactor));m.lookAt(Q);a=new THREE.Vector3(Y/R,1,0);
m.up.add(a.sub(m.up).multiplyScalar(.05));S.rotation=-P.getElapsedTime()*Math.PI*1.5;z.render(t,m);J.render(I,H)};(function(){W=document.getElementById("container");X=new THREE.Projector;z=new THREE.WebGLRenderer({alpha:!0,antialias:!0});z.setClearColor(0,0);z.setSize(window.innerWidth,window.innerHeight);W.appendChild(z.domElement);t=new THREE.Scene;m=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.5,3E6);P=new THREE.Clock;var d=transformSVGPath(x),k=d.getLength(),p=[],c;for(c in a.slopes){var h=
a.slopes[c];p.push(new THREE.Vector3(h.percent/100*k,h.offset*a.slopeScale,0))}slopePathSplineCurve3=new THREE.ClosedSplineCurve3(p);d=d.getSpacedPoints(1500,!0);k=[];for(c=0;c<d.length;c++)k.push(new THREE.Vector3(d[c].x,slopePathSplineCurve3.getPointAt(c/d.length).y,d[c].y));L=new THREE.ClosedSplineCurve3(k);f=L.getLength();aa=1E3*a.trackLengthKM;N=aa/f;var p=new THREE.PlaneGeometry(7,f,1,1500),v=f/1500;for(c=0;c<p.vertices.length;c+=2){var n=v*c/2,s=q(n/f),n=O(n),n=n.cross(new THREE.Vector3(0,
1,0)),n=n.clone().multiplyScalar(3),w=p.vertices[c+1];w.addVectors(s,n);w=p.vertices[c];w.addVectors(s,n.negate())}p.verticesNeedUpdate=!0;p.computeBoundingSphere();p.computeBoundingBox();D=p.boundingSphere.center.clone().negate();d={name:b.data.weibo.name,distance:b.data.weibo.distance,rankings:b.data.weibo.rankings,lap:b.data.weibo.lap,speed:1E3*b.data.weibo.speed/60/60/N,sideOffset:2.5,typeIndex:b.data.weibo.typeIndex,faster:0};d.distance1=U(d.distance);d.lap0=d.lap;k={name:b.data.twitter.name,
distance:b.data.twitter.distance,rankings:b.data.twitter.rankings,lap:b.data.twitter.lap,speed:1E3*b.data.twitter.speed/60/60/N,sideOffset:-2.5,typeIndex:b.data.twitter.typeIndex,faster:0};k.distance1=U(k.distance);k.lap0=k.lap;I=new THREE.Scene;h=new THREE.PlaneGeometry(7,f,1,1500);v=f/1500;for(c=0;c<h.vertices.length;c+=2)n=v*c/2,s=q(n/f),n=O(n),n=n.cross(new THREE.Vector3(0,3,0)),n=n.clone().multiplyScalar(3),w=h.vertices[c+1],w.addVectors(s,n),w=h.vertices[c],w.addVectors(s,n.negate());h.verticesNeedUpdate=
!0;h.computeBoundingSphere();h.computeBoundingBox();c=h.boundingSphere.center.clone().negate();meshMap=new THREE.Mesh(h,new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}));h=h.boundingBox;v=h.max.x-h.min.x+200;s=h.max.z-h.min.z+200;h=200;n=s/v*h;meshMap.position.add(c);meshMap.matrixAutoUpdate=!1;meshMap.updateMatrix();I.add(meshMap);map=document.getElementById("map");J=new THREE.WebGLRenderer({alpha:!0,antialias:!0});J.setClearColor(0,0);J.setSize(h,n);map.appendChild(J.domElement);
H=new THREE.OrthographicCamera(v/-2,v/2,s/2,s/-2,-500,2E3);H.position.set(0,1E3,0);H.up.set(0,0,-1);H.lookAt(new THREE.Vector3(0,0,0));A=new THREE.Mesh(new THREE.SphereGeometry(30),new THREE.MeshBasicMaterial({color:16711680}));A.position.set(0,100,0);A.userData=d;I.add(A);B=new THREE.Mesh(new THREE.SphereGeometry(30),new THREE.MeshBasicMaterial({color:255}));B.position.set(0,100,0);B.userData=k;I.add(B);c=THREE.ImageUtils.loadTexture("image/track.png?"+(new Date).getTime());c.wrapS=c.wrapT=THREE.RepeatWrapping;
c.repeat.set(1,50);u=new THREE.Mesh(p,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,map:c}));u.geometry.computeBoundingSphere();u.position.add(D);u.matrixAutoUpdate=!1;u.updateMatrix();t.add(u);Z=u.geometry.boundingSphere.radius;c=new THREE.CircleGeometry(3*Z,50);c.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));c.vertices.shift();p=new THREE.Line(c,new THREE.LineBasicMaterial({color:10066329}));p.position.add(D);p.matrixAutoUpdate=!1;p.updateMatrix();t.add(p);
c=c.clone();c.applyMatrix((new THREE.Matrix4).makeTranslation(0,20,0));c=new THREE.Line(c,new THREE.LineBasicMaterial({color:16777215}));c.position.add(D);c.matrixAutoUpdate=!1;c.updateMatrix();t.add(c);K=new THREE.Object3D;t.add(K);c=new THREE.PlaneGeometry(5,50,2,50);e=new THREE.Mesh(c,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-red.png?"+(new Date).getTime())}));e.frustumCulled=!1;e.position.set(0,1,0);e.matrixAutoUpdate=
!1;e.updateMatrix();e.userData=d;M(A,e,!1);K.add(e);c=new THREE.PlaneGeometry(5,50,2,50);g=new THREE.Mesh(c,new THREE.MeshBasicMaterial({transparent:!0,opacity:1,side:THREE.DoubleSide,alphaTest:.5,map:THREE.ImageUtils.loadTexture("image/car-blue.png?"+(new Date).getTime())}));g.frustumCulled=!1;g.position.set(0,1.2,0);g.userData=k;M(B,g,!1);K.add(g);ga({imageUrl:"image/track-infobox.png?"+(new Date).getTime(),opacity:.86,size:15,fixedScaleFactor:.015,finishCallback:function(a){F=a;t.add(F)},drawCallback:function(a,
b){a.fillStyle=TYPES[b.typeIndex].color;a.textBaseline="top";a.font="28pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(b.name,12,8);a.font="42pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+b.rankings,40,50);a.font="26pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(rankingsTitle(b.rankings),72,50);a.font="15pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";a.fillText(""+Math.round(b.speed*N*3600/1E3)+"km/h",125,58);a.font="14pt 'Porsche News Gothic','\u9ed1\u4f53','sans-serif'";
a.fillText("Lap:"+Math.round(b.lap),125,84)}});k=document.createElement("canvas");k.width=k.height=20;d=new THREE.Texture(k);k=k.getContext("2d");h=1;k.lineWidth=h;k.lineJoin="miter";k.strokeStyle="white";k.beginPath();k.moveTo(h,h);k.lineTo(20-h,h);k.lineTo(20-h,20-h);k.lineTo(h,20-h);k.closePath();k.stroke();d.needsUpdate=!0;S=new THREE.SpriteMaterial({opacity:.6,map:d});for(c=0;c<a.particle.count;c++)d=new THREE.Sprite(S),d.position.copy(q(c/a.particle.count)).add(new THREE.Vector3(100*(Math.random()-
.5),10*(Math.random()-.5),100*(Math.random()-.5))),d.scale.multiplyScalar(.5+.3*Math.random()),t.add(d);m.position.set(l.initPosition.x,l.initPosition.y,l.initPosition.z);m.lookAt(q(0));window.addEventListener("resize",r,!1);document.addEventListener("mousemove",C,!1);document.addEventListener("click",E,!1);ba();T&&T()})()}})}})}})})()};
